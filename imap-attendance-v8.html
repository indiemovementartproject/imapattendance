<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iMAP Attendance Sheet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --card: #10161d;
      --border: #1f2a36;
      --muted: #0f1a24;
      --text: #f5f7fa;
      --subtle: #c9d4e1;
      --accent: #7cc4ff;
      --danger:#ef4444;
      --okbg: #0b3d2e;
      --okfg:#d1fae5;
      --okbd:#14532d;

      --col-student: 220px;
      --col-phone: 160px;

      --ctl-fs: 13px;
      --ctl-py: 6px;
      --ctl-px: 8px;
      --btn-sm-px: 10px;
      --btn-sm-radius: 10px;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--card); position: sticky; top: 0; z-index: 10; display: flex; justify-content: center; align-items: center; text-align: center; gap:10px; flex-wrap: wrap; }
    h1 { margin: 0; font-size: 20px; font-weight: 600; color: var(--text); }
    .branch-tag { font-size: 12px; color: var(--subtle); }
    .logo { display:none; }

    .wrap { padding: 16px 20px; }

    .topbar { display:none; justify-content:flex-start; align-items:center; margin: 6px 0 8px; }
    .topbar.show { display:flex; }
    .btn--back { padding: 2px 6px; font-size: 10px; border-radius: 8px; }

    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; justify-content: center; }
    .tab-btn { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--subtle); padding: 8px 12px; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 500; }
    .tab-btn:hover { border-color: var(--accent); color: var(--text); }
    .tab-btn.active { background: var(--accent); color: #00131f; border-color: var(--accent); }

    .panel { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; overflow-x: auto; }
    .panel.active { display: block; }

    table { border-collapse: collapse; margin: 8px auto; background: var(--card); }
    th, td { border: 1px solid var(--border); padding: 6px; text-align: center; font-size: 13px; vertical-align: top; color: var(--text); white-space: nowrap; }
    thead th { background: #0f1a24; font-weight: 600; position: sticky; top: 0; z-index: 3; }
    thead tr.day-row th { background: #0b141b; font-weight: 500; font-size: 11px; }
    tfoot td { background: #0f1a24; font-weight: 600; }

    tfoot td[id^="classTotal-"] { background: var(--okbg); color: var(--okfg); font-weight: 700; border-color: var(--okbd); }
    #overviewTables td[id^="fees-Total-"] { background: var(--okbg); color: var(--okfg); font-weight: 700; border-color: var(--okbd); }

    tbody tr:nth-child(even) td { background: #0e1622; }
    tbody tr:hover td { background: #132238; transition: background .15s ease; }

    table.collapsed .day-col { display: none; }

    table[id^="classTable-"] th:first-child,
    table[id^="classTable-"] td:first-child { width: var(--col-student); text-align: center; }
    table[id^="classTable-"] th:nth-child(2),
    table[id^="classTable-"] td:nth-child(2) { width: var(--col-phone); }

    #overviewTables table { table-layout: auto; margin: 8px auto; }
    #overviewTables table th, #overviewTables table td { width: auto; padding: 5px; }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; color: var(--subtle); justify-content: center; }
    .controls label { font-size: 12px; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; }

    select, input[type="text"], input[type="password"] {
      padding: var(--ctl-py) var(--ctl-px);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: var(--ctl-fs);
      background: #0b141b;
      color: var(--text);
    }
    select:focus, input[type="text"]:focus, input[type="password"]:focus { outline: 2px solid var(--accent); outline-offset: 0; border-color: var(--accent); }
    input[type="text"], input[type="password"] { width: 100%; }
    input.notes { width: auto !important; min-width: 160px; }

    .phone.invalid { border-color: var(--danger); box-shadow: 0 0 0 2px rgba(239,68,68,.15); }

    .grid { display: grid; gap: 12px; }
    .month-title { margin: 8px 0 2px; font-size: 14px; font-weight: 600; color: var(--accent); text-align: center; }

    .hidden { display: none !important; }

    .branch-gate { text-align:center; margin: 10px 0 14px; }
    .branch-buttons { display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
    .btn {
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 14px 20px;
      border-radius: 16px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      font-size: 16px;
    }
    .btn:hover { border-color: var(--accent); color: var(--text); }
    .btn.primary { background: var(--accent); color:#00131f; border-color: var(--accent); }

    body.compact th, body.compact td { padding: 3px; font-size: 12px; }
    body.compact .tab-btn { padding:6px 8px; }

    @media print {
      :root { --bg:#fff; --card:#fff; --border:#000; --text:#000; }
      body { background:#fff; color:#000; }
      header { position: static; background:#fff; border:none; }
      .topbar, .tabs, .sync-bar, #branchGate, .controls label input, .controls label select, label input[type="checkbox"] { display:none !important; }
      table { margin: 0 auto; }
      th, td { color:#000; border-color:#000; background:#fff !important; }
      tfoot td[id^="classTotal-"] { background:#d9f2e6 !important; color:#000 !important; }
      @page { size: A4 portrait; margin: 12mm; }
      .logo { display:block !important; max-height: 36px; margin-right: 8px; }
    }

    td select { width: 100%; min-width: 80px; }
    td input.fee { text-align: right; }

    .sync-bar { display:flex; gap:8px; align-items:center; margin: 6px 0; flex-wrap: wrap; justify-content: center; }
    .sync-bar .btn {
      font-weight:600;
      padding: var(--ctl-py) var(--btn-sm-px);
      font-size: var(--ctl-fs);
      border-radius: var(--btn-sm-radius);
    }
    .sync-bar input[type="text"], .sync-bar input[type="password"] { width: 220px; }
    .sync-bar .status { font-size: 12px; color: var(--subtle); min-width: 160px; text-align: center; }

    @media (max-width: 768px) {
      .wrap { padding: 12px; }
      h1 { font-size: 18px; }
      .tabs { flex-wrap: nowrap; }
      .tab-btn { padding: 8px 10px; font-size: 12px; }
      th, td { padding: 4px; font-size: 12px; }
      td select { min-width: 64px; }
      .controls { flex-direction: column; align-items: center; gap: 8px; }
      .controls label select, .controls label input { width: 100%; }
      .sync-bar input[type="text"], .sync-bar input[type="password"] { width: 100%; max-width: 280px; }
      .branch-buttons .btn { width: min(280px, 90vw); }
    }

    #overview .grid { justify-items: center; }
  </style>
</head>
<body>
  <header>
    <img id="logo" class="logo" src="" alt="Logo" />
    <h1>iMAP Attendance Sheet <span id="branchTag" class="branch-tag"></span></h1>
  </header>

  <div class="wrap">
    <div id="branchGate" class="branch-gate">
      <h2 style="margin:8px 0 4px; font-weight:600; color:var(--text); font-size:16px;">Select Branch</h2>
      <div class="branch-buttons">
        <button class="btn" data-branch="Seawoods">Seawoods</button>
        <button class="btn" data-branch="Belapur">Belapur</button>
      </div>
    </div>

    <div id="topbar" class="topbar">
      <button id="backBtn" class="btn btn--back">← Back to branches</button>
    </div>

    <div class="tabs hidden"></div>

    <div class="sync-bar hidden">
      <input id="ghToken" type="password" placeholder="GitHub Token (gist scope)" />
      <input id="gistId" type="text" placeholder="Gist ID (leave blank to create)" />
      <input id="gistFilename" type="text" placeholder="Filename" value="imap-attendance.json" />
      <label style="font-size:12px;color:var(--subtle)"><input id="autoSync" type="checkbox" style="vertical-align:middle;margin-right:6px;"/>Auto Sync</label>
      <label style="font-size:12px;color:var(--subtle)"><input id="compactToggle" type="checkbox" style="vertical-align:middle;margin-right:6px;"/>Compact</label>
      <button id="pullBtn" class="btn">Pull</button>
      <button id="pushBtn" class="btn">Push</button>
      <span id="syncStatus" class="status"></span>
    </div>

    <div id="panels" class="hidden"></div>
  </div>

  <script>
  'use strict';
  (function(){
    (function(){
      if (!Element.prototype.matches) {
        Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
      }
      if (!Element.prototype.closest) {
        Element.prototype.closest = function(s) {
          var el = this;
          if (!document.documentElement.contains(el)) return null;
          do { if (el.matches(s)) return el; el = el.parentElement || el.parentNode; }
          while (el && el.nodeType === 1);
          return null;
        };
      }
    })();

    function forEachNode(list, fn){ Array.prototype.forEach.call(list, fn); }
    function idSafe(s){ return String(s).replace(/\s+/g,'_'); }
    function ensure(obj, key, def){ if(!obj[key]) obj[key]=def; return obj[key]; }
    function sanitizeNumber(raw){
      if(typeof raw !== 'string') raw = String(raw || '');
      var m = raw.replace(/,/g,'').match(/\d+(?:\.\d+)?/);
      return m ? parseFloat(m[0]) : 0;
    }

    var _measureSpan = null;
    function getMeasureSpan(){
      if(_measureSpan) return _measureSpan;
      var span = document.createElement('span');
      span.style.position = 'absolute';
      span.style.visibility = 'hidden';
      span.style.whiteSpace = 'pre';
      span.style.top = '-9999px';
      span.style.left = '-9999px';
      document.body.appendChild(span);
      _measureSpan = span;
      return span;
    }
    function autosizeInput(input){
      var span = getMeasureSpan();
      var cs = window.getComputedStyle(input);
      span.style.fontFamily = cs.fontFamily;
      span.style.fontSize = cs.fontSize;
      span.style.fontWeight = cs.fontWeight;
      span.style.letterSpacing = cs.letterSpacing;
      span.textContent = input.value || input.placeholder || '';
      var extra = 24;
      input.style.width = (span.offsetWidth + extra) + 'px';
    }
    function bindAutosize(input){
      autosizeInput(input);
      input.addEventListener('input', function(){ autosizeInput(input); });
      input.addEventListener('change', function(){ autosizeInput(input); });
    }
    function autosizeAllNotes(container){
      forEachNode(container.querySelectorAll('input.notes'), bindAutosize);
    }

    var months = ["August 2025","September 2025","October 2025","November 2025","December 2025"];
    var classLabels = {};
    var BRANCHES = {
      Seawoods: {
        labels: { JazzTraining: "Jazz Training", JazzFunk: "Jazz Funk", BollywoodWeekends: "Bollywood Weekends", BalletTraining: "Ballet Training" },
        configs: { JazzTraining:{allowedDays:[6]}, JazzFunk:{allowedDays:[0]}, BollywoodWeekends:{allowedDays:[6,0]}, BalletTraining:{allowedDays:[6]} },
        order: ["JazzTraining","JazzFunk","BollywoodWeekends","BalletTraining"]
      },
      Belapur: {
        labels: { JazzFunk: "Jazz Funk", BollywoodWeekdays: "Bollywood Weekdays", Juniors: "Juniors batch", OpenStyle: "Open Style" },
        configs: { JazzFunk:{allowedDays:[1,5]}, BollywoodWeekdays:{allowedDays:[2,4]}, Juniors:{allowedDays:[2,4]}, OpenStyle:{allowedDays:[2,4]} },
        order: ["JazzFunk","BollywoodWeekdays","Juniors","OpenStyle"]
      }
    };
    var CLASS_CONFIGS = {};
    var CURRENT_BRANCH = null;

    var STORAGE_KEY = 'imap-attendance-v1';
    function loadStore(){
      try {
        var raw = localStorage.getItem(STORAGE_KEY);
        var parsed = raw ? JSON.parse(raw) : null;
        if(parsed && typeof parsed === 'object') return parsed;
      } catch(e){ console.error('Store load failed', e); }
      return {version:1, selectedMonths:{}, data:{}, meta:{updatedAt:0}};
    }
    var STORE = loadStore();
    function persist(){ try { localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE)); } catch(e){ console.error('Store save failed', e); } }
    function getBranchData(){ ensure(STORE,'data',{}); if(!CURRENT_BRANCH) return {}; ensure(STORE.data,CURRENT_BRANCH,{}); return STORE.data[CURRENT_BRANCH]; }
    function getBranchSelectedMonths(){ ensure(STORE,'selectedMonths',{}); if(!CURRENT_BRANCH) return {}; ensure(STORE.selectedMonths,CURRENT_BRANCH,{}); return STORE.selectedMonths[CURRENT_BRANCH]; }
    function getCollapsePrefs(){ ensure(STORE,'meta',{}); ensure(STORE.meta,'collapse',{}); if(!CURRENT_BRANCH) return {}; ensure(STORE.meta.collapse,CURRENT_BRANCH,{}); return STORE.meta.collapse[CURRENT_BRANCH]; }
    function bumpMeta(){
      ensure(STORE,'meta',{});
      ensure(STORE.meta,'deviceId','');
      STORE.meta.updatedAt = Date.now();
      try {
        if (!STORE.meta.deviceId) {
          STORE.meta.deviceId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : Math.random().toString(36).slice(2);
        }
      } catch(e){ STORE.meta.deviceId = Math.random().toString(36).slice(2); }
    }

    var SYNC_KEY = 'imap-sync-settings';
    function loadSyncSettings(){ try { return JSON.parse(localStorage.getItem(SYNC_KEY)) || {}; } catch (e) { return {}; } }
    function saveSyncSettings(obj){ localStorage.setItem(SYNC_KEY, JSON.stringify(obj)); }
    function setStatus(msg, isError){
      var elStatus = document.getElementById('syncStatus');
      elStatus.textContent = msg || '';
      elStatus.style.color = isError ? '#ef9a9a' : 'var(--subtle)';
    }
    function api(path, opts){
      opts = opts || {};
      var s = loadSyncSettings();
      var token = s.token ? s.token.trim() : '';
      if(!token) return Promise.reject(new Error('Add your GitHub token'));
      var merged = { method: 'GET', headers: { 'Accept': 'application/vnd.github+json', 'Authorization': 'Bearer ' + token } };
      for (var k in opts){ merged[k]=opts[k]; }
      return fetch('https://api.github.com' + path, merged).then(function(res){
        if(!res.ok){ return res.text().then(function(t){ throw new Error('GitHub API ' + res.status + ': ' + t); }); }
        return res.json();
      });
    }
    function gistPushUpdate(gistId, filename, content){ return api('/gists/'+gistId, { method:'PATCH', body: JSON.stringify({ files: { [filename]: { content: content } } }) }); }
    function gistCreate(filename, content){ return api('/gists', { method:'POST', body: JSON.stringify({ description:'iMAP Attendance Sheet data', public:false, files:{ [filename]: { content: content } } }) }); }
    function gistGet(gistId){ return api('/gists/'+gistId); }

    var dirtySince = 0;
    function payload(){ return JSON.stringify(STORE, null, 2); }

    function pushNow(force){
      var s = loadSyncSettings();
      var filename = (s.filename || 'imap-attendance.json').trim();
      if(!(s.token && s.token.trim())) return Promise.reject(new Error('Add your GitHub token'));
      bumpMeta(); persist();
      var body = payload();
      if(s.gistId){
        return gistPushUpdate(s.gistId, filename, body).then(function(){ setStatus('Pushed to Gist'); dirtySince=0; });
      } else {
        return gistCreate(filename, body).then(function(created){
          var s2 = loadSyncSettings(); s2.gistId = created.id; saveSyncSettings(s2); document.getElementById('gistId').value = s2.gistId;
          setStatus('Created new Gist and pushed'); dirtySince=0;
        });
      }
    }
    function pullNow(){
      var s = loadSyncSettings();
      if(!(s.token && s.token.trim())) return Promise.reject(new Error('Add your GitHub token'));
      if(!(s.gistId && s.gistId.trim())) return Promise.reject(new Error('Add a Gist ID (or Push to create one)'));
      var filename = (s.filename || 'imap-attendance.json').trim();
      return gistGet(s.gistId).then(function(g){
        var file = g.files && g.files[filename];
        if(!file) throw new Error('File not found in gist: ' + filename);
        var textPromise = Promise.resolve(file.content);
        if(file.truncated || !file.content){
          textPromise = fetch(file.raw_url).then(function(r){ if(!r.ok) throw new Error('Failed to fetch gist raw'); return r.text(); });
        }
        return textPromise.then(function(text){
          var incoming = JSON.parse(text);
          var remoteTs = (incoming.meta && incoming.meta.updatedAt) || 0;
          var localTs = (STORE.meta && STORE.meta.updatedAt) || 0;
          if(remoteTs <= localTs && !dirtySince){ setStatus('Already up to date'); return; }
          STORE = incoming; persist(); applyStoreToUI(); setStatus('Pulled from Gist'); dirtySince = 0;
        });
      });
    }
    function smartSync(){
      try{
        var s = loadSyncSettings();
        if(!s.auto) return;
        if(!(s.token && s.filename)) return;
        if(!(s.gistId)){ pushNow(true).catch(function(e){ setStatus('Auto push error: '+e.message,true); }); return; }
        gistGet(s.gistId).then(function(g){
          var filename = (s.filename || 'imap-attendance.json').trim();
          var file = g.files && g.files[filename];
          var textPromise = Promise.resolve(file && file.content);
          if(file && (file.truncated || !file.content)){
            textPromise = fetch(file.raw_url).then(function(r){ if(!r.ok) throw new Error('Failed to fetch gist raw'); return r.text(); });
          }
          return textPromise.then(function(text){
            var incoming = text ? JSON.parse(text) : null;
            var remoteTs = incoming && incoming.meta ? (incoming.meta.updatedAt||0) : 0;
            var localTs = STORE && STORE.meta ? (STORE.meta.updatedAt||0) : 0;
            if(remoteTs > localTs && (!dirtySince || remoteTs > dirtySince)){
              STORE = incoming; persist(); applyStoreToUI(); setStatus('Auto: pulled'); dirtySince = 0; return;
            }
            if(localTs > remoteTs){
              pushNow(true).then(function(){ setStatus('Auto: pushed'); }).catch(function(e){ setStatus('Auto push error: '+e.message,true); });
            }
          });
        }).catch(function(e){ setStatus('Auto sync error: '+e.message,true); });
      } catch(e){ setStatus('Auto sync error: '+e.message, true); }
    }
    var autoTimer = null;
    function setupAutoSync(){
      if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
      var s = loadSyncSettings();
      if(s.auto){ autoTimer=setInterval(smartSync, 30000); }
    }
    function bindSyncUI(){
      var s = loadSyncSettings();
      var elToken = document.getElementById('ghToken');
      var elGistId = document.getElementById('gistId');
      var elFilename = document.getElementById('gistFilename');
      var elAuto = document.getElementById('autoSync');
      var elCompact = document.getElementById('compactToggle');
      elToken.value = s.token || '';
      elGistId.value = s.gistId || '';
      elFilename.value = s.filename || 'imap-attendance.json';
      elAuto.checked = !!s.auto;
      if (elCompact) {
        var compact = STORE && STORE.meta ? !!STORE.meta.compact : false;
        document.body.classList.toggle('compact', compact);
        elCompact.checked = compact;
        elCompact.addEventListener('change', function(){
          if(!STORE.meta) STORE.meta = {};
          STORE.meta.compact = elCompact.checked; persist();
          document.body.classList.toggle('compact', elCompact.checked);
        });
      }
      elToken.addEventListener('input', function(){ var s=loadSyncSettings(); s.token = elToken.value.trim(); saveSyncSettings(s); });
      elGistId.addEventListener('input', function(){ var s=loadSyncSettings(); s.gistId = elGistId.value.trim(); saveSyncSettings(s); });
      elFilename.addEventListener('input', function(){ var s=loadSyncSettings(); s.filename = elFilename.value.trim() || 'imap-attendance.json'; saveSyncSettings(s); });
      elAuto.addEventListener('change', function(){ var s=loadSyncSettings(); s.auto = elAuto.checked; saveSyncSettings(s); setupAutoSync(); });
      document.getElementById('pullBtn').addEventListener('click', function(){ pullNow().catch(function(err){ setStatus(err.message, true); }); });
      document.getElementById('pushBtn').addEventListener('click', function(){ pushNow(true).catch(function(err){ setStatus(err.message, true); }); });
    }

    function buildOverviewTables(){
      var wrap = document.getElementById('overviewTables');
      wrap.innerHTML = '';
      var order = BRANCHES[CURRENT_BRANCH].order;
      months.forEach(function(month){
        var mId = idSafe(month);
        var html = '';
        html += '<div>';
        html += '<div class="month-title">'+month+'</div>';
        html += '<table><thead><tr>';
        html += '<th></th>';
        order.forEach(function(k){ html += '<th>'+classLabels[k]+'</th>'; });
        html += '<th>Total</th>';
        html += '</tr></thead><tbody>';
        html += '<tr><td>Present</td>';
        order.forEach(function(k){ html += '<td id="present-'+k+'-'+mId+'">0</td>'; });
        html += '<td id="present-Total-'+mId+'">0</td></tr>';
        html += '<tr><td>Absent</td>';
        order.forEach(function(k){ html += '<td id="absent-'+k+'-'+mId+'">0</td>'; });
        html += '<td id="absent-Total-'+mId+'">0</td></tr>';
        html += '<tr><td>Fees</td>';
        order.forEach(function(k){ html += '<td id="fees-'+k+'-'+mId+'">0</td>'; });
        html += '<td id="fees-Total-'+mId+'">0</td></tr>';
        html += '</tbody></table></div>';
        var node = document.createElement('div');
        node.innerHTML = html;
        wrap.appendChild(node.firstChild);
      });
      recomputeOverviewFromStore();
    }

    var TYPE_OPTIONS = ["", "New", "Renewal", "Revival", "Carry-Forward", "Shift in Carry-Forward"];

    function renderUIForBranch(){
      var tabsEl = document.querySelector('.tabs');
      var order = BRANCHES[CURRENT_BRANCH].order;
      var tabsHtml = ['overview'].concat(order).map(function(id){
        var label = id==='overview' ? 'Overview' : classLabels[id];
        return '<button class="tab-btn'+(id==='overview'?' active':'')+'" data-tab="'+id+'">'+label+'</button>';
      }).join('');
      tabsEl.innerHTML = tabsHtml;

      var panels = document.getElementById('panels');
      var phtml = '<section id="overview" class="panel active"><div class="grid"><div id="overviewTables"></div></div></section>';
      order.forEach(function(k){ phtml += '<section id="'+k+'" class="panel"></section>'; });
      panels.innerHTML = phtml;

      document.querySelector('.tabs').classList.remove('hidden');
      document.querySelector('.sync-bar').classList.remove('hidden');
      document.getElementById('panels').classList.remove('hidden');
      document.getElementById('topbar').classList.add('show');

      document.getElementById('branchTag').textContent = '— ' + CURRENT_BRANCH + ' Branch';

      buildOverviewTables();
      order.forEach(buildClassPanel);

      tabsEl.addEventListener('click', function(e){
        var btn = e.target.closest ? e.target.closest('.tab-btn') : null;
        if(!btn) return;
        var toId = btn.getAttribute('data-tab');
        forEachNode(document.querySelectorAll('.tab-btn'), function(b){ b.classList.toggle('active', b===btn); });
        forEachNode(document.querySelectorAll('.panel'), function(p){ p.classList.toggle('active', p.id===toId); });
      });
    }

    function validTillLabelSeq(startMonthIdx, startYear){
      var items = [];
      for(var i=0;i<12;i++){
        var mIdx = (startMonthIdx + i) % 12;
        var y = startYear + Math.floor((startMonthIdx + i)/12);
        items.push({mIdx:mIdx, y:y});
      }
      var firstY = items[0].y, lastY = items[items.length-1].y;
      var sameYear = firstY === lastY;
      return items.map(function(it){
        var short = new Date(it.y, it.mIdx, 1).toLocaleString('en-US',{month:'short'});
        return {value:(it.y+'-'+(it.mIdx+1)), label: (sameYear ? short : (short+' '+it.y))};
      });
    }

    function getDaysInMonthByWeekdays(monthIndex, year, allowedDays){
      var days = [];
      var d = new Date(year, monthIndex, 1);
      while(d.getMonth() === monthIndex){
        if(allowedDays.indexOf(d.getDay()) !== -1){
          var label = d.getDate() + '/' + (d.getMonth()+1);
          days.push({date: new Date(d), label: label});
        }
        d.setDate(d.getDate()+1);
      }
      return days;
    }

    function refreshValidTillOptionsFor(classKey, monthIndex, year){
      var table = document.getElementById('classTable-'+classKey);
      if(!table) return;
      var options = validTillLabelSeq(monthIndex, year);
      var selects = table.querySelectorAll('select.validTill');
      forEachNode(selects, function(sel){
        var current = sel.value;
        sel.innerHTML = '<option value=""></option>' + options.map(function(o){ return '<option value="'+o.value+'">'+o.label+'</option>'; }).join('');
        if(current) {
          var opt = sel.querySelector('option[value="'+current+'"]');
          sel.value = opt ? current : '';
        }
      });
    }

    function buildClassPanel(classKey){
      var cfg = CLASS_CONFIGS[classKey];
      var panel = document.getElementById(classKey);
      var monthOptions = months.map(function(m){ return '<option>'+m+'</option>'; }).join('');
      panel.innerHTML = ''
        + '<div class="controls">'
        + '<label><strong>'+cfg.label+'</strong></label>'
        + '<label>Month: <select id="monthSelect-'+classKey+'">'+monthOptions+'</select></label>'
        + '<label><input type="checkbox" id="collapseToggle-'+classKey+'" /> Collapse attendance</label>'
        + '</div>'
        + '<div id="classTableContainer-'+classKey+'"></div>';

      var select = document.getElementById('monthSelect-'+classKey);
      var selMap = getBranchSelectedMonths();
      if(selMap && selMap[classKey]){
        var saved = selMap[classKey];
        var has = Array.prototype.some.call(select.options, function(o){ return o.value===saved; });
        if(has) select.value = saved;
      }
      select.addEventListener('change', function(){ generateClassTable(classKey); saveCurrentClassState(classKey); });
      generateClassTable(classKey);

      var collapseToggle = document.getElementById('collapseToggle-'+classKey);
      if (collapseToggle) {
        var pref = !!getCollapsePrefs()[classKey];
        collapseToggle.checked = pref;
        var tbl0 = document.getElementById('classTable-'+classKey);
        if (tbl0 && pref) tbl0.classList.add('collapsed');
        collapseToggle.addEventListener('change', function(e){
          var tbl = document.getElementById('classTable-'+classKey);
          if (tbl) tbl.classList.toggle('collapsed', e.target.checked);
          var c = getCollapsePrefs(); c[classKey] = e.target.checked; persist();
        });
      }
    }

    function generateClassTable(classKey){
      var cfg = CLASS_CONFIGS[classKey];
      var monthStr = document.getElementById('monthSelect-'+classKey).value;
      var parts = monthStr.split(' ');
      var monthName = parts[0], yearStr = parts[1];
      var year = parseInt(yearStr,10);
      var monthIndex = new Date(monthName+' 1, '+year).getMonth();
      var days = getDaysInMonthByWeekdays(monthIndex, year, cfg.allowedDays);

      var html = '<table id="classTable-'+classKey+'">';
      html += '<thead><tr><th>Student Name</th><th>Phone No.</th>';
      days.forEach(function(d){ html += '<th class="day-col">'+d.label+'</th>'; });
      html += '<th>Fees Paid</th><th>Type</th><th>Valid Till</th><th>Notes</th></tr>';
      html += '<tr class="day-row"><th></th><th></th>';
      days.forEach(function(d){ html += '<th class="day-col">'+['SUN','MON','TUE','WED','THU','FRI','SAT'][d.date.getDay()]+'</th>'; });
      html += '<th></th><th></th><th></th><th></th></tr></thead><tbody>';

      for(var r=1; r<=15; r++){
        html += '<tr>';
        html += '<td><input type="text" placeholder="Student '+r+'"></td>';
        html += '<td><input type="text" class="phone" placeholder="" /></td>';
        days.forEach(function(){ html += '<td class="day-col"><select><option value=""> </option><option value="Present">Present</option><option value="Absent">Absent</option><option value="Drop-in">Drop-in</option></select></td>'; });
        html += '<td><input type="text" class="fee" placeholder="" /></td>';
        html += '<td><select class="type">'+ TYPE_OPTIONS.map(function(opt){ return '<option value="'+opt+'">'+opt+'</option>'; }).join('') +'</select></td>';
        html += '<td><select class="validTill"><option value=""></option></select></td>';
        html += '<td><input type="text" class="notes" placeholder=""/></td>';
        html += '</tr>';
      }
      html += '</tbody><tfoot><tr><td><strong>Total Fees</strong></td><td></td><td colspan="'+days.length+'"></td><td id="classTotal-'+classKey+'">0</td><td></td><td></td><td></td></tr></tfoot></table>';

      var container = document.getElementById('classTableContainer-'+classKey);
      container.innerHTML = html;

      var tblApply = document.getElementById('classTable-'+classKey);
      if (getCollapsePrefs()[classKey]) tblApply.classList.add('collapsed');

      forEachNode(container.querySelectorAll('input.phone'), attachPhoneValidation);
      forEachNode(container.querySelectorAll('input[type="text"], select'), function(elm){
        elm.addEventListener('change', function(){ updateClassTotals(classKey); saveCurrentClassState(classKey); if(elm.classList.contains('notes')) autosizeInput(elm); });
        elm.addEventListener('input', function(){ updateClassTotals(classKey); saveCurrentClassState(classKey); if(elm.classList.contains('notes')) autosizeInput(elm); });
      });

      refreshValidTillOptionsFor(classKey, monthIndex, year);
      restoreClassTable(classKey);
      autosizeAllNotes(container);
      updateClassTotals(classKey);
    }

    function updateClassTotals(classKey){
      var table = document.getElementById('classTable-'+classKey);
      if(!table) return;
      var month = document.getElementById('monthSelect-'+classKey).value;
      var mId = idSafe(month);

      var present = 0, absent = 0, feesTotal = 0;

      forEachNode(table.querySelectorAll('tbody tr'), function(row){
        var feeRaw = (row.querySelector('input.fee') && row.querySelector('input.fee').value) || '';
        var feeVal = sanitizeNumber(feeRaw);
        feesTotal += feeVal;

        forEachNode(row.querySelectorAll('select:not(.type):not(.validTill)'), function(sel){
          var v = sel.value;
          if(v === 'Present' || v === 'Drop-in'){ present++; }
          else if(v === 'Absent'){ absent++; }
        });
      });

      var classTotalCell = document.getElementById('classTotal-'+classKey);
      if(classTotalCell) classTotalCell.textContent = feesTotal;

      var pCell = document.getElementById('present-'+classKey+'-'+mId);
      var aCell = document.getElementById('absent-'+classKey+'-'+mId);
      var fCell = document.getElementById('fees-'+classKey+'-'+mId);
      if(pCell) pCell.textContent = present;
      if(aCell) aCell.textContent = absent;
      if(fCell) fCell.textContent = feesTotal;

      updateOverviewTotalsForMonth(month);
    }

    function updateOverviewTotalsForMonth(month){
      var mId = idSafe(month);
      var order = BRANCHES[CURRENT_BRANCH].order;
      ['present','absent','fees'].forEach(function(type){
        var sum = order.reduce(function(acc,k){
          var cell = document.getElementById(type+'-'+k+'-'+mId);
          return acc + (parseFloat(cell ? cell.textContent : '0') || 0);
        },0);
        var totalCell = document.getElementById(type+'-Total-'+mId);
        if(totalCell) totalCell.textContent = sum;
      });
    }

    function restoreClassTable(classKey){
      var table = document.getElementById('classTable-'+classKey);
      var month = document.getElementById('monthSelect-'+classKey).value;
      var mId = idSafe(month);
      var bd = getBranchData();
      var rows = (bd[classKey] && bd[classKey][mId]) || [];
      if(!table || rows.length===0) return;
      var bodyRows = Array.prototype.slice.call(table.querySelectorAll('tbody tr'));
      bodyRows.forEach(function(tr, idx){
        var data = rows[idx]; if(!data) return;
        var tds = Array.prototype.slice.call(tr.children);
        if(tds[0]) tds[0].querySelector('input').value = (data.name!=null?data.name:'');
        if(tds[1]) tds[1].querySelector('input').value = (data.phone!=null?data.phone:'');
        var dayCells = tds.slice(2, -4);
        for(var i=0;i<dayCells.length;i++){
          var sel = dayCells[i].querySelector('select');
          if(!sel) continue;
          var val = (data.days && data.days[i]) || '';
          var has = Array.prototype.some.call(sel.options, function(o){ return o.value===val; });
          sel.value = has ? val : '';
        }
        tds[tds.length-4].querySelector('input').value = (data.fee!=null?data.fee:'');
      tds[tds.length-3].querySelector('select').value = (data.type!=null?data.type:'');
        tds[tds.length-2].querySelector('select').value = (data.validTill!=null?data.validTill:'');
        var notesEl = tds[tds.length-1].querySelector('input.notes');
        if(notesEl){ notesEl.value = (data.notes!=null?data.notes:''); autosizeInput(notesEl); }
      });
    }

    function saveCurrentClassState(classKey){
      var table = document.getElementById('classTable-'+classKey);
      var month = document.getElementById('monthSelect-'+classKey).value;
      var mId = idSafe(month);
      if(!table) return;
      var rows = [];
      forEachNode(table.querySelectorAll('tbody tr'), function(tr){
        var tds = Array.prototype.slice.call(tr.children);
        var name = (tds[0].querySelector('input') && tds[0].querySelector('input').value) || '';
        var phone = (tds[1].querySelector('input') && tds[1].querySelector('input').value) || '';
        var daySelects = tds.slice(2, -4).map(function(td){ return td.querySelector('select'); });
        var days = daySelects.map(function(sel){ return sel ? sel.value : ''; });
        var fee = (tds[tds.length-4].querySelector('input') && tds[tds.length-4].querySelector('input').value) || '';
        var type = (tds[tds.length-3].querySelector('select') && tds[tds.length-3].querySelector('select').value) || '';
        var validTill = (tds[tds.length-2].querySelector('select') && tds[tds.length-2].querySelector('select').value) || '';
        var notes = (tds[tds.length-1].querySelector('input.notes') && tds[tds.length-1].querySelector('input.notes').value) || '';
        rows.push({name:name, phone:phone, days:days, fee:fee, type:type, validTill:validTill, notes:notes});
      });
      var branchData = getBranchData();
      ensure(branchData,classKey,{}); branchData[classKey][mId] = rows;
      var sel = getBranchSelectedMonths(); sel[classKey] = month;
      bumpMeta(); persist(); recomputeOverviewFromStore(); dirtySince = STORE.meta.updatedAt;
    }

    function setBranch(branch){
      CURRENT_BRANCH = branch;
      classLabels = {};
      var labels = BRANCHES[branch].labels;
      for(var k in labels){ if(Object.prototype.hasOwnProperty.call(labels,k)) classLabels[k]=labels[k]; }
      CLASS_CONFIGS = {};
      var cfgs = BRANCHES[branch].configs;
      for(var ck in cfgs){ if(Object.prototype.hasOwnProperty.call(cfgs,ck)) CLASS_CONFIGS[ck] = { label: classLabels[ck], allowedDays: cfgs[ck].allowedDays.slice() }; }
      document.getElementById('branchGate').classList.add('hidden');
      renderUIForBranch();
    }
    function goBackToBranches(){
      CURRENT_BRANCH = null;
      document.getElementById('branchGate').classList.remove('hidden');
      document.querySelector('.tabs').classList.add('hidden');
      document.querySelector('.sync-bar').classList.add('hidden');
      document.getElementById('panels').classList.add('hidden');
      document.getElementById('topbar').classList.remove('show');
      document.querySelector('.tabs').innerHTML = '';
      document.getElementById('panels').innerHTML = '';
      document.getElementById('branchTag').textContent = '';
    }
    function applyStoreToUI(){
      if(!CURRENT_BRANCH) return;
      renderUIForBranch();
      recomputeOverviewFromStore();
    }

    function attachPhoneValidation(input){
      input.classList.add('phone');
      input.setAttribute('inputmode','numeric');
      input.addEventListener('input', function(){
        var digits = input.value.replace(/\D/g,'').slice(0,10);
        input.value = digits;
        if(digits.length===0){ input.classList.remove('invalid'); return; }
        if(digits.length!==10){ input.classList.add('invalid'); }
        else { input.classList.remove('invalid'); }
      });
      input.addEventListener('blur', function(){
        var digits = input.value.replace(/\D/g,'');
        if(digits.length!==0 && digits.length!==10){ input.classList.add('invalid'); }
      });
    }

    function recomputeOverviewFromStore(){
      if(!CURRENT_BRANCH) return;
      var bd = getBranchData();
      var order = BRANCHES[CURRENT_BRANCH].order;
      months.forEach(function(month){
        var mId = idSafe(month);
        var present=0, absent=0, fees=0;
        for(var oi=0; oi<order.length; oi++){
          var classKey = order[oi];
          var rows = (bd[classKey] && bd[classKey][mId]) || [];
          rows.forEach(function(r){
            (r.days||[]).forEach(function(v){ if(v==='Present'||v==='Drop-in') present++; else if(v==='Absent') absent++; });
            fees += sanitizeNumber(r.fee||0);
          });
          var pCell = document.getElementById('present-'+classKey+'-'+mId);
          var aCell = document.getElementById('absent-'+classKey+'-'+mId);
          var fCell = document.getElementById('fees-'+classKey+'-'+mId);
          if(pCell) pCell.textContent = rows.reduce(function(acc,r){ return acc + (r.days||[]).filter(function(v){ return v==='Present'||v==='Drop-in'; }).length; }, 0);
          if(aCell) aCell.textContent = rows.reduce(function(acc,r){ return acc + (r.days||[]).filter(function(v){ return v==='Absent'; }).length; }, 0);
          if(fCell) fCell.textContent = rows.reduce(function(acc,r){ return acc + sanitizeNumber(r.fee||0); }, 0);
        }
        var tP = document.getElementById('present-Total-'+mId);
        var tA = document.getElementById('absent-Total-'+mId);
        var tF = document.getElementById('fees-Total-'+mId);
        if(tP) tP.textContent = present;
        if(tA) tA.textContent = absent;
        if(tF) tF.textContent = fees;
      });
    }

    function bindStaticUI(){
      forEachNode(document.querySelectorAll('button[data-branch]'), function(btn){
        btn.addEventListener('click', function(){ setBranch(btn.getAttribute('data-branch')); });
      });
      var back = document.getElementById('backBtn');
      if(back) back.addEventListener('click', goBackToBranches);
    }

    bindStaticUI();
    bindSyncUI();
    setupAutoSync();
    document.addEventListener('visibilitychange', function(){ if(!document.hidden) smartSync(); });
  })();
  </script>
</body>
</html>
