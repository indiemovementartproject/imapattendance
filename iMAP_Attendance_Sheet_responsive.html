<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iMAP Attendance Sheet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --card: #10161d;
      --border: #1f2a36;
      --muted: #0f1a24;
      --text: #f5f7fa;
      --subtle: #c9d4e1;
      --accent: #7cc4ff; /* light blue highlight */
      --danger:#ef4444;
      --sticky1: 220px; /* Student column width */
      --sticky2: 140px; /* Phone column width */
    }
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--card); position: sticky; top: 0; z-index: 10; display: flex; justify-content: center; align-items: center; text-align: center; }
    h1 { margin: 0; font-size: 20px; font-weight: 600; color: var(--text); }

    .wrap { padding: 16px 20px; }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .tab-btn { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--subtle); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 500; }
    .tab-btn:hover { border-color: var(--accent); color: var(--text); }
    .tab-btn.active { background: var(--accent); color: #00131f; border-color: var(--accent); }

    .panel { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; overflow-x: auto; }
    .panel.active { display: block; }

    table { border-collapse: collapse; margin-top: 8px; background: var(--card); }
    th, td { border: 1px solid var(--border); padding: 6px; text-align: center; font-size: 13px; vertical-align: top; color: var(--text); white-space: nowrap; }
    thead th { background: #0f1a24; font-weight: 600; position: sticky; top: 0; z-index: 3; }
    thead tr.day-row th { background: #0b141b; font-weight: 500; font-size: 11px; }
    tfoot td { background: #0f1a24; font-weight: 600; }

    /* Sticky + widths ONLY for class tables */
    table[id^="classTable-"] th:first-child,
    table[id^="classTable-"] td:first-child { width: var(--sticky1); text-align: left; }

    table[id^="classTable-"] th:nth-child(2),
    table[id^="classTable-"] td:nth-child(2) { width: var(--sticky2); }

    /* Overview tables: compact columns & extra padding */
    #overviewTables table { table-layout: auto; margin: 8px auto; }
    #overviewTables table th, #overviewTables table td { width: auto; padding: 5px; }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; color: var(--subtle); }
    .controls label { font-size: 12px; }
    select, input[type="text"], textarea { padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 13px; background: #0b141b; color: var(--text); }
    select:focus, input[type="text"]:focus, textarea:focus { outline: 2px solid var(--accent); outline-offset: 0; border-color: var(--accent); }
    input[type="text"], textarea { width: 100%; }
    textarea { resize: vertical; min-height: 30px; }

    .phone.invalid { border-color: var(--danger); box-shadow: 0 0 0 2px rgba(239,68,68,.15); }

    .grid { display: grid; gap: 12px; }
    .month-title { margin: 8px 0 2px; font-size: 14px; font-weight: 600; color: var(--accent); text-align: center; }

    /* Compact selects in attendance grid */
    td select { width: 100%; min-width: 80px; }
    td input.fee { text-align: right; }
  
    /* Mobile-friendly tweaks */
    @media (max-width: 768px) {
      .wrap { padding: 12px; }
      h1 { font-size: 18px; }
      .tabs { flex-wrap: nowrap; }
      .tab-btn { padding: 8px 10px; font-size: 12px; }
      th, td { padding: 4px; font-size: 12px; }
      td select { min-width: 64px; }
      .controls { flex-direction: column; align-items: stretch; gap: 8px; }
      .controls label select, .controls label input { width: 100%; }
    }
  
    /* Center overview tables within the Overview panel */
    #overview .grid { justify-items: center; }
  </style>
</head>
<body>
  <header>
    <h1>iMAP Attendance Sheet</h1>
  </header>

  <div class="wrap">
    <div class="tabs">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="JazzTraining">Jazz Training</button>
      <button class="tab-btn" data-tab="JazzFunk">Jazz Funk</button>
      <button class="tab-btn" data-tab="BollywoodWeekends">Bollywood Weekends</button>
      <button class="tab-btn" data-tab="BalletTraining">Ballet Training</button>
    </div>

    <!-- Overview Panel -->
    <section id="overview" class="panel active">
      <div class="grid">
        <div id="overviewTables"></div>
      </div>
    </section>

    <!-- Class Panels -->
    <section id="JazzTraining" class="panel"></section>
    <section id="JazzFunk" class="panel"></section>
    <section id="BollywoodWeekends" class="panel"></section>
    <section id="BalletTraining" class="panel"></section>
  </div>

  <!-- All JS contained in a single module to avoid global redeclarations -->
  <script type="module">
    // ---------------- Config ----------------
    const months = ["August 2025","September 2025","October 2025","November 2025","December 2025"];
    const classLabels = {
      JazzTraining: "Jazz Training",
      JazzFunk: "Jazz Funk",
      BollywoodWeekends: "Bollywood Weekends",
      BalletTraining: "Ballet Training"
    };

    // Safe id helper (avoid spaces in id attributes)
    const idSafe = (s) => String(s).replace(/\s+/g, '_');

    // ---------- Utilities ----------
    function switchTab(toId){
      document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.toggle('active', btn.dataset.tab===toId));
      document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id===toId));
    }
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
    });

    function getDaysInMonthByWeekdays(monthIndex, year, allowedDays){
      // monthIndex: 0-11; allowedDays: array of 0(Sun)..6(Sat)
      const days = [];
      const d = new Date(year, monthIndex, 1);
      while(d.getMonth() === monthIndex){
        if(allowedDays.includes(d.getDay())){
          const label = `${d.getDate()}/${d.getMonth()+1}`; // D/M
          days.push({date: new Date(d), label});
        }
        d.setDate(d.getDate()+1);
      }
      return days; // chronological
    }

    function el(html){
      const t = document.createElement('template');
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }

    // Numeric sanitizer: returns first number found (int/decimal), else 0
    function sanitizeNumber(raw){
      if(typeof raw !== 'string') raw = String(raw ?? '');
      const m = raw.replace(/,/g,'').match(/\d+(?:\.\d+)?/);
      return m ? parseFloat(m[0]) : 0;
    }

    // Phone validation: digits only, 10 max; blank is OK
    function attachPhoneValidation(input){
      input.classList.add('phone');
      input.setAttribute('inputmode','numeric');
      input.addEventListener('input', ()=>{
        const digits = input.value.replace(/\D/g,'').slice(0,10);
        input.value = digits;
        if(digits.length===0){ input.classList.remove('invalid'); return; }
        if(digits.length!==10){ input.classList.add('invalid'); }
        else { input.classList.remove('invalid'); }
      });
      input.addEventListener('blur', ()=>{
        const digits = input.value.replace(/\D/g,'');
        if(digits.length!==0 && digits.length!==10){ input.classList.add('invalid'); }
      });
    }

    // Auto-resize textarea
    function autoResizeTA(ta){
      const handler = ()=>{ ta.style.height='auto'; ta.style.height = (ta.scrollHeight+2)+'px'; };
      ta.addEventListener('input', handler); handler();
    }

    // ---------- Overview Tables (one per month) ----------
    function buildOverviewTables(){
      const wrap = document.getElementById('overviewTables');
      wrap.innerHTML = '';
      months.forEach(month => {
        const mId = idSafe(month);
        const table = el(`
          <div>
            <div class="month-title">${month}</div>
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>${classLabels.JazzTraining}</th>
                  <th>${classLabels.JazzFunk}</th>
                  <th>${classLabels.BollywoodWeekends}</th>
                  <th>${classLabels.BalletTraining}</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Present</td>
                  <td id="present-JazzTraining-${mId}">0</td>
                  <td id="present-JazzFunk-${mId}">0</td>
                  <td id="present-BollywoodWeekends-${mId}">0</td>
                  <td id="present-BalletTraining-${mId}">0</td>
                  <td id="present-Total-${mId}">0</td>
                </tr>
                <tr>
                  <td>Absent</td>
                  <td id="absent-JazzTraining-${mId}">0</td>
                  <td id="absent-JazzFunk-${mId}">0</td>
                  <td id="absent-BollywoodWeekends-${mId}">0</td>
                  <td id="absent-BalletTraining-${mId}">0</td>
                  <td id="absent-Total-${mId}">0</td>
                </tr>
                <tr>
                  <td>Fees</td>
                  <td id="fees-JazzTraining-${mId}">0</td>
                  <td id="fees-JazzFunk-${mId}">0</td>
                  <td id="fees-BollywoodWeekends-${mId}">0</td>
                  <td id="fees-BalletTraining-${mId}">0</td>
                  <td id="fees-Total-${mId}">0</td>
                </tr>
              </tbody>
            </table>
          </div>
        `);
        wrap.appendChild(table);
      });
    }

    function updateOverviewTotalsForMonth(month){
      const mId = idSafe(month);
      ["present","absent","fees"].forEach(type => {
        const j = parseFloat(document.getElementById(`${type}-JazzTraining-${mId}`).textContent) || 0;
        const jf = parseFloat(document.getElementById(`${type}-JazzFunk-${mId}`).textContent) || 0;
        const bw = parseFloat(document.getElementById(`${type}-BollywoodWeekends-${mId}`).textContent) || 0;
        const bt = parseFloat(document.getElementById(`${type}-BalletTraining-${mId}`).textContent) || 0;
        const totalCell = document.getElementById(`${type}-Total-${mId}`);
        totalCell.textContent = j + jf + bw + bt;
      });
    }

    // ---------- Class Tab Factory ----------
    const CLASS_CONFIGS = {
      JazzTraining: { label: classLabels.JazzTraining, allowedDays: [0] }, // Sundays
      JazzFunk: { label: classLabels.JazzFunk, allowedDays: [0] }, // Sundays
      BollywoodWeekends: { label: classLabels.BollywoodWeekends, allowedDays: [6,0] }, // Sat & Sun
      BalletTraining: { label: classLabels.BalletTraining, allowedDays: [6] } // Saturdays
    };

    const TYPE_OPTIONS = ["", "New", "Renewal", "Revival", "Carry-Forward", "Shift in Carry-Forward"];

    function buildClassPanel(classKey){
      const cfg = CLASS_CONFIGS[classKey];
      const panel = document.getElementById(classKey);
      const monthOptions = months.map(m=>`<option>${m}</option>`).join('');
      panel.innerHTML = `
        <div class="controls">
          <label><strong>${cfg.label}</strong></label>
          <label>Month: <select id="monthSelect-${classKey}">${monthOptions}</select></label>
        </div>
        <div id="classTableContainer-${classKey}"></div>
      `;

      const select = document.getElementById(`monthSelect-${classKey}`);
      select.addEventListener('change', ()=> generateClassTable(classKey));
      generateClassTable(classKey); // initial
    }

    function validTillLabelSeq(startMonthIdx, startYear){
      // Return array of 12 labels from selected month onward. Hide year if all in same year.
      const items = [];
      for(let i=0;i<12;i++){
        const mIdx = (startMonthIdx + i) % 12;
        const y = startYear + Math.floor((startMonthIdx + i)/12);
        items.push({mIdx, y});
      }
      const firstY = items[0].y, lastY = items[items.length-1].y;
      const sameYear = firstY === lastY;
      return items.map(({mIdx,y})=>{
        const short = new Date(y, mIdx, 1).toLocaleString('en-US',{month:'short'});
        return {value:`${y}-${mIdx+1}`, label: sameYear ? short : `${short} ${y}`};
      });
    }

    function generateClassTable(classKey){
      const cfg = CLASS_CONFIGS[classKey];
      const monthStr = document.getElementById(`monthSelect-${classKey}`).value; // e.g., "August 2025"
      const [monthName, yearStr] = monthStr.split(' ');
      const year = parseInt(yearStr, 10);
      const monthIndex = new Date(`${monthName} 1, ${year}`).getMonth();
      const days = getDaysInMonthByWeekdays(monthIndex, year, cfg.allowedDays);

      let html = `<table id="classTable-${classKey}">`;
      // Header row 1: date labels
      html += `<thead><tr><th>Student Name</th><th>Phone No.</th>`;
      days.forEach(d => { html += `<th>${d.label}</th>`; });
      html += `<th>Fees Paid</th><th>Type</th><th>Valid Till</th><th>Notes</th></tr>`;
      // Header row 2: day short forms
      html += `<tr class="day-row"><th></th><th></th>`;
      days.forEach(d => { html += `<th>${['SUN','MON','TUE','WED','THU','FRI','SAT'][d.date.getDay()]}</th>`; });
      html += `<th></th><th></th><th></th><th></th></tr></thead><tbody>`;

      for(let r=1; r<=15; r++){
        html += `<tr>`;
        html += `<td><input type="text" placeholder="Student ${r}"></td>`;
        html += `<td><input type="text" class="phone" placeholder="" /></td>`;
        days.forEach(()=>{
          html += `<td><select>
            <option value=""> </option>
            <option value="Present">Present</option>
            <option value="Absent">Absent</option>
            <option value="Drop-in">Drop-in</option>
          </select></td>`;
        });
        html += `<td><input type="text" class="fee" placeholder="" /></td>`;
        html += `<td><select class="type">
          ${TYPE_OPTIONS.map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
        </select></td>`;
        html += `<td><select class="validTill"><option value=""></option></select></td>`;
        html += `<td><textarea rows="1" placeholder=""></textarea></td>`;
        html += `</tr>`;
      }
      html += `</tbody><tfoot><tr><td><strong>Total Fees</strong></td><td></td><td colspan="${days.length}"></td><td id="classTotal-${classKey}">0</td><td></td><td></td><td></td></tr></tfoot></table>`;

      const container = document.getElementById(`classTableContainer-${classKey}`);
      container.innerHTML = html;

      // Attach behaviors
      container.querySelectorAll('input.phone').forEach(inp=> attachPhoneValidation(inp));
      container.querySelectorAll('textarea').forEach(ta=> autoResizeTA(ta));
      container.querySelectorAll('select, input.fee').forEach(elm => {
        elm.addEventListener('change', ()=> updateClassTotals(classKey));
        elm.addEventListener('input',  ()=> updateClassTotals(classKey));
      });

      // Populate Valid Till selects based on current month selection
      refreshValidTillOptionsFor(classKey, monthIndex, year);

      // Initial compute
      updateClassTotals(classKey);
    }

    function refreshValidTillOptionsFor(classKey, monthIndex, year){
      const table = document.getElementById(`classTable-${classKey}`);
      if(!table) return;
      const options = validTillLabelSeq(monthIndex, year); // 12 from selected
      const selects = table.querySelectorAll('select.validTill');
      selects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = `<option value=""></option>` + options.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
        if(current) {
          const opt = sel.querySelector(`option[value="${current}"]`);
          if(opt) sel.value = current; else sel.value = '';
        }
      });
    }

    function updateClassTotals(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      if(!table) return;
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);

      let present = 0, absent = 0, feesTotal = 0;

      table.querySelectorAll('tbody tr').forEach(row => {
        const feeRaw = row.querySelector('input.fee').value || '';
        const feeVal = sanitizeNumber(feeRaw);
        feesTotal += feeVal;

        row.querySelectorAll('select:not(.type):not(.validTill)').forEach(sel => {
          const v = sel.value;
          if(v === 'Present' || v === 'Drop-in'){
            present++;
          } else if(v === 'Absent') {
            absent++;
          }
        });
      });

      // Update class tab total
      const classTotalCell = document.getElementById(`classTotal-${classKey}`);
      if(classTotalCell) classTotalCell.textContent = feesTotal;

      // Push into Overview
      const pCell = document.getElementById(`present-${classKey}-${mId}`);
      const aCell = document.getElementById(`absent-${classKey}-${mId}`);
      const fCell = document.getElementById(`fees-${classKey}-${mId}`);
      if(pCell) pCell.textContent = present;
      if(aCell) aCell.textContent = absent;
      if(fCell) fCell.textContent = feesTotal;

      updateOverviewTotalsForMonth(month);
    }

    // Build everything once
    buildOverviewTables();
    ["JazzTraining","JazzFunk","BollywoodWeekends","BalletTraining"].forEach(buildClassPanel);

    // ---------------- Lightweight Test Cases ----------------
    (function runTests(){
      try {
        console.assert(typeof classLabels === 'object', 'classLabels should be an object');
        console.assert(['JazzTraining','JazzFunk','BollywoodWeekends','BalletTraining'].every(k=>k in classLabels), 'classLabels missing keys');
        console.assert(Array.isArray(months) && months.length >= 1, 'months should be a non-empty array');

        // Overview cells exist for first month
        const m0 = idSafe(months[0]);
        console.assert(document.getElementById(`present-JazzTraining-${m0}`), 'Overview present cell missing');

        // Class tables rendered and totals cell present
        ['JazzTraining','JazzFunk','BollywoodWeekends','BalletTraining'].forEach(key => {
          const totalCell = document.getElementById(`classTotal-${key}`);
          console.assert(totalCell, `classTotal cell missing for ${key}`);
        });

        // Phone validation attaches
        const anyPhone = document.querySelector('input.phone');
        console.assert(anyPhone, 'Phone input not found');

        console.log('%ciMAP sheet: basic tests passed', 'color:#0bf');
      } catch (e) {
        console.error('Test failure:', e);
      }
    })();
  </script>
</body>
</html>
