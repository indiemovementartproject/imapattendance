<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iMAP Attendance Sheet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --card: #10161d;
      --border: #1f2a36;
      --muted: #0f1a24;
      --text: #f5f7fa;
      --subtle: #c9d4e1;
      --accent: #7cc4ff; /* light blue highlight */
      --danger:#ef4444;
      --col-student: 220px;
      --col-phone: 160px;
      --okbg: #0b3d2e; --okfg:#d1fae5; --okbd:#14532d;

      /* unified control sizing so inputs & small buttons match height */
      --ctl-fs: 13px;
      --ctl-py: 6px;
      --ctl-px: 8px;
      --btn-sm-px: 10px;
      --btn-sm-radius: 10px;
    }
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--card); position: sticky; top: 0; z-index: 10; display: flex; justify-content: center; align-items: center; text-align: center; gap:10px; }
    h1 { margin: 0; font-size: 20px; font-weight: 600; color: var(--text); }
    .logo { display:none; }

    .wrap { padding: 16px 20px; }

    /* Topbar with Back button (shown after branch selected) */
    .topbar { display:none; justify-content:flex-start; align-items:center; margin: 6px 0 8px; }
    .topbar.show { display:flex; }
    .btn--back { padding: var(--ctl-py) var(--btn-sm-px); font-size: var(--ctl-fs); border-radius: var(--btn-sm-radius); }

    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; justify-content: center; }
    .tab-btn { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--subtle); padding: 8px 12px; border-radius: 12px; cursor: pointer; font-family: inherit; font-weight: 500; }
    .tab-btn:hover { border-color: var(--accent); color: var(--text); }
    .tab-btn.active { background: var(--accent); color: #00131f; border-color: var(--accent); }

    .panel { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; overflow-x: auto; }
    .panel.active { display: block; }

    table { border-collapse: collapse; margin: 8px auto; background: var(--card); }
    th, td { border: 1px solid var(--border); padding: 6px; text-align: center; font-size: 13px; vertical-align: top; color: var(--text); white-space: nowrap; }
    thead th { background: #0f1a24; font-weight: 600; position: sticky; top: 0; z-index: 3; }
    thead tr.day-row th { background: #0b141b; font-weight: 500; font-size: 11px; }
    tfoot td { background: #0f1a24; font-weight: 600; }

    /* Highlight totals */
    tfoot td[id^="classTotal-"] { background: var(--okbg); color: var(--okfg); font-weight: 700; border-color: var(--okbd); }
    #overviewTables td[id^="fees-Total-"] { background: var(--okbg); color: var(--okfg); font-weight: 700; border-color: var(--okbd); }

    /* Zebra rows & subtle hover */
    tbody tr:nth-child(even) td { background: #0e1622; }
    tbody tr:hover td { background: #132238; transition: background .15s ease; }

    /* Collapsible attendance columns */
    table.collapsed .day-col { display: none; }

    /* Fixed widths (no sticky columns) */
    table[id^="classTable-"] th:first-child,
    table[id^="classTable-"] td:first-child { width: var(--col-student); text-align: center; }
    table[id^="classTable-"] th:nth-child(2),
    table[id^="classTable-"] td:nth-child(2) { width: var(--col-phone); }

    /* Overview tables */
    #overviewTables table { table-layout: auto; margin: 8px auto; }
    #overviewTables table th, #overviewTables table td { width: auto; padding: 5px; }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; color: var(--subtle); justify-content: center; }
    .controls label { font-size: 12px; }
    select, input[type="text"], textarea, input[type="password"] {
      padding: var(--ctl-py) var(--ctl-px);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: var(--ctl-fs);
      background: #0b141b;
      color: var(--text);
    }
    select:focus, input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: 2px solid var(--accent); outline-offset: 0; border-color: var(--accent); }
    input[type="text"], textarea, input[type="password"] { width: 100%; }
    textarea { resize: vertical; min-height: 30px; }

    .phone.invalid { border-color: var(--danger); box-shadow: 0 0 0 2px rgba(239,68,68,.15); }

    .grid { display: grid; gap: 12px; }
    .month-title { margin: 8px 0 2px; font-size: 14px; font-weight: 600; color: var(--accent); text-align: center; }

    /* Utility */
    .hidden { display: none !important; }

    /* Branch gate */
    .branch-gate { text-align:center; margin: 10px 0 14px; }
    .branch-buttons { display:flex; gap:14px; justify-content:center; flex-wrap:wrap; }
    .btn {
      border:1px solid var(--border);
      background: var(--card);
      color: var(--text);
      padding: 14px 20px;
      border-radius: 16px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      font-size: 16px;
    }
    .btn:hover { border-color: var(--accent); color: var(--text); }
    /* .btn.primary kept for future use */
    .btn.primary { background: var(--accent); color:#00131f; border-color: var(--accent); }

    /* Compact mode */
    body.compact th, body.compact td { padding: 3px; font-size: 12px; }
    body.compact .tab-btn { padding:6px 8px; }
    body.compact textarea { min-height:24px; }

    /* Print friendly (A4) */
    @media print {
      :root { --bg:#fff; --card:#fff; --border:#000; --text:#000; }
      body { background:#fff; color:#000; }
      header { position: static; background:#fff; border:none; }
      .topbar, .tabs, .sync-bar, #branchGate, .controls label input, .controls label select, label input[type="checkbox"] { display:none !important; }
      table { margin: 0 auto; }
      th, td { color:#000; border-color:#000; background:#fff !important; }
      tfoot td[id^="classTotal-"] { background:#d9f2e6 !important; color:#000 !important; }
      @page { size: A4 portrait; margin: 12mm; }
      .logo { display:block !important; max-height: 36px; margin-right: 8px; }
    }

    /* Compact selects in attendance grid */
    td select { width: 100%; min-width: 80px; }
    td input.fee { text-align: right; }

    /* Sync bar */
    .sync-bar { display:flex; gap:8px; align-items:center; margin: 6px 0; flex-wrap: wrap; justify-content: center; }
    .sync-bar .btn {
      font-weight:600;
      /* small buttons same height feel as inputs */
      padding: var(--ctl-py) var(--btn-sm-px);
      font-size: var(--ctl-fs);
      border-radius: var(--btn-sm-radius);
    }
    .sync-bar input[type="text"], .sync-bar input[type="password"] { width: 220px; }
    .sync-bar .status { font-size: 12px; color: var(--subtle); min-width: 160px; text-align: center; }

    /* Mobile-friendly tweaks */
    @media (max-width: 768px) {
      .wrap { padding: 12px; }
      h1 { font-size: 18px; }
      .tabs { flex-wrap: nowrap; }
      .tab-btn { padding: 8px 10px; font-size: 12px; }
      th, td { padding: 4px; font-size: 12px; }
      td select { min-width: 64px; }
      .controls { flex-direction: column; align-items: center; gap: 8px; }
      .controls label select, .controls label input { width: 100%; }
      .sync-bar input[type="text"], .sync-bar input[type="password"] { width: 100%; max-width: 280px; }
      .branch-buttons .btn { width: min(280px, 90vw); }
    }

    /* Center overview tables within the Overview panel */
    #overview .grid { justify-items: center; }
  </style>
</head>
<body>
  <header>
    <img id="logo" class="logo" src="" alt="Logo" />
    <h1>iMAP Attendance Sheet</h1>
  </header>

  <div class="wrap">
    <div id="branchGate" class="branch-gate">
      <h2 style="margin:8px 0 4px; font-weight:600; color:var(--text); font-size:16px;">Select Branch</h2>
      <div class="branch-buttons">
        <button class="btn" data-branch="Seawoods">Seawoods</button>
        <button class="btn" data-branch="Belapur">Belapur</button>
      </div>
    </div>

    <!-- Back button (shown after selecting a branch), now small and left-aligned -->
    <div id="topbar" class="topbar">
      <button id="backBtn" class="btn btn--back">‚Üê Back to branches</button>
    </div>

    <div class="tabs hidden"></div>

    <div class="sync-bar hidden">
      <input id="ghToken" type="password" placeholder="GitHub Token (gist scope)" />
      <input id="gistId" type="text" placeholder="Gist ID (leave blank to create)" />
      <input id="gistFilename" type="text" placeholder="Filename" value="imap-attendance.json" />
      <label style="font-size:12px;color:var(--subtle)"><input id="autoSync" type="checkbox" style="vertical-align:middle;margin-right:6px;"/>Auto Sync</label>
      <label style="font-size:12px;color:var(--subtle)"><input id="compactToggle" type="checkbox" style="vertical-align:middle;margin-right:6px;"/>Compact</label>
      <button id="pullBtn" class="btn">Pull</button>
      <button id="pushBtn" class="btn">Push</button>
      <span id="syncStatus" class="status"></span>
    </div>

    <div id="panels" class="hidden"></div>
  </div>

  <script type="module">
    // ---------------- Config ----------------
    const months = ["August 2025","September 2025","October 2025","November 2025","December 2025"];
    let classLabels = {};
    const BRANCHES = {
      Seawoods: {
        labels: { JazzTraining: "Jazz Training", JazzFunk: "Jazz Funk", BollywoodWeekends: "Bollywood Weekends", BalletTraining: "Ballet Training" },
        // Jazz Training now SATURDAY (6)
        configs: { JazzTraining:{allowedDays:[6]}, JazzFunk:{allowedDays:[0]}, BollywoodWeekends:{allowedDays:[6,0]}, BalletTraining:{allowedDays:[6]} },
        order: ["JazzTraining","JazzFunk","BollywoodWeekends","BalletTraining"]
      },
      Belapur: {
        labels: { JazzFunk: "Jazz Funk", BollywoodWeekdays: "Bollywood Weekdays", Juniors: "Juniors batch", OpenStyle: "Open Style" },
        // Mon=1, Tue=2, Thu=4, Fri=5
        configs: { JazzFunk:{allowedDays:[1,5]}, BollywoodWeekdays:{allowedDays:[2,4]}, Juniors:{allowedDays:[2,4]}, OpenStyle:{allowedDays:[2,4]} },
        order: ["JazzFunk","BollywoodWeekdays","Juniors","OpenStyle"]
      }
    };
    let CLASS_CONFIGS = {};
    let CURRENT_BRANCH = null;

    const idSafe = (s) => String(s).replace(/\s+/g, '_');

    // ---------------- Persistence ----------------
    const STORAGE_KEY = 'imap-attendance-v1';
    function loadStore(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        return parsed && typeof parsed === 'object' ? parsed : {version:1, selectedMonths:{}, data:{}, meta:{updatedAt:0}};
      } catch(e){
        console.error('Store load failed', e); return {version:1, selectedMonths:{}, data:{}, meta:{updatedAt:0}};
      }
    }
    let STORE = loadStore();
    function persist(){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE)); }
      catch(e){ console.error('Store save failed', e); }
    }
    function getBranchData(){ STORE.data ||= {}; if(!CURRENT_BRANCH) return {}; STORE.data[CURRENT_BRANCH] ||= {}; return STORE.data[CURRENT_BRANCH]; }
    function getBranchSelectedMonths(){ STORE.selectedMonths ||= {}; if(!CURRENT_BRANCH) return {}; STORE.selectedMonths[CURRENT_BRANCH] ||= {}; return STORE.selectedMonths[CURRENT_BRANCH]; }
    function getCollapsePrefs(){ STORE.meta ||= {}; STORE.meta.collapse ||= {}; if(!CURRENT_BRANCH) return {}; STORE.meta.collapse[CURRENT_BRANCH] ||= {}; return STORE.meta.collapse[CURRENT_BRANCH]; }

    function bumpMeta(){
      STORE.meta ||= {}; STORE.meta.updatedAt = Date.now(); STORE.meta.deviceId = getDeviceId();
    }

    function saveCurrentClassState(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);
      if(!table) return;
      const rows = [];
      table.querySelectorAll('tbody tr').forEach(tr => {
        const tds = [...tr.children];
        const name = tds[0].querySelector('input')?.value || '';
        const phone = tds[1].querySelector('input')?.value || '';
        const daySelects = tds.slice(2, -4).map(td=> td.querySelector('select'));
        const days = daySelects.map(sel => sel ? sel.value : '');
        const fee = tds[tds.length-4].querySelector('input')?.value || '';
        const type = tds[tds.length-3].querySelector('select')?.value || '';
        const validTill = tds[tds.length-2].querySelector('select')?.value || '';
        const notes = tds[tds.length-1].querySelector('textarea')?.value || '';
        rows.push({name, phone, days, fee, type, validTill, notes});
      });
      const branchData = getBranchData();
      branchData[classKey] ||= {}; branchData[classKey][mId] = rows;
      const sel = getBranchSelectedMonths(); sel[classKey] = month;
      bumpMeta(); persist(); recomputeOverviewFromStore(); dirtySince = STORE.meta.updatedAt;
    }

    function restoreClassTable(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);
      const rows = (getBranchData()?.[classKey]?.[mId]) || []; 
      if(!table || rows.length===0) return;
      const bodyRows = [...table.querySelectorAll('tbody tr')];
      bodyRows.forEach((tr, idx) => {
        const data = rows[idx]; if(!data) return;
        const tds = [...tr.children];
        if(tds[0]) tds[0].querySelector('input').value = data.name ?? '';
        if(tds[1]) tds[1].querySelector('input').value = data.phone ?? '';
        const dayCells = tds.slice(2, -4);
        for(let i=0;i<dayCells.length;i++){
          const sel = dayCells[i].querySelector('select');
          if(!sel) continue;
          const val = (data.days && data.days[i]) || '';
          sel.value = [...sel.options].some(o=>o.value===val) ? val : '';
        }
        tds[tds.length-4].querySelector('input').value = data.fee ?? '';
        tds[tds.length-3].querySelector('select').value = data.type ?? '';
        tds[tds.length-2].querySelector('select').value = data.validTill ?? '';
        tds[tds.length-1].querySelector('textarea').value = data.notes ?? '';
      });
    }

    function recomputeOverviewFromStore(){
      if(!CURRENT_BRANCH) return;
      const branchData = getBranchData();
      const order = BRANCHES[CURRENT_BRANCH].order;
      months.forEach(month => {
        const mId = idSafe(month);
        let present=0, absent=0, fees=0;
        for(const classKey of order){
          const rows = branchData?.[classKey]?.[mId] || [];
          rows.forEach(r => {
            (r.days||[]).forEach(v=>{ if(v==='Present'||v==='Drop-in') present++; else if(v==='Absent') absent++; });
            fees += sanitizeNumber(r.fee||0);
          });
          const pCell = document.getElementById(`present-${classKey}-${mId}`);
          const aCell = document.getElementById(`absent-${classKey}-${mId}`);
          const fCell = document.getElementById(`fees-${classKey}-${mId}`);
          if(pCell) pCell.textContent = rows.reduce((acc, r)=> acc + (r.days||[]).filter(v=>v==='Present'||v==='Drop-in').length, 0);
          if(aCell) aCell.textContent = rows.reduce((acc, r)=> acc + (r.days||[]).filter(v=>v==='Absent').length, 0);
          if(fCell) fCell.textContent = rows.reduce((acc, r)=> acc + sanitizeNumber(r.fee||0), 0);
        }
        const tP = document.getElementById(`present-Total-${mId}`);
        const tA = document.getElementById(`absent-Total-${mId}`);
        const tF = document.getElementById(`fees-Total-${mId}`);
        if(tP) tP.textContent = present;
        if(tA) tA.textContent = absent;
        if(tF) tF.textContent = fees;
      });
    }

    // ---------- GitHub Gist Sync ----------
    const SYNC_KEY = 'imap-sync-settings';
    const GITHUB_API = 'https://api.github.com';
    let SYNC = loadSyncSettings();
    function loadSyncSettings(){ try { return JSON.parse(localStorage.getItem(SYNC_KEY)) || {}; } catch { return {}; } }
    function saveSyncSettings(){ localStorage.setItem(SYNC_KEY, JSON.stringify(SYNC)); }
    function getDeviceId(){ SYNC.deviceId ||= (crypto?.randomUUID?.() || Math.random().toString(36).slice(2)); saveSyncSettings(); return SYNC.deviceId; }

    const elToken = document.getElementById('ghToken');
    const elGistId = document.getElementById('gistId');
    const elFilename = document.getElementById('gistFilename');
    const elAuto = document.getElementById('autoSync');
    const elCompact = document.getElementById('compactToggle');
    const elStatus = document.getElementById('syncStatus');
    const btnPull = document.getElementById('pullBtn');
    const btnPush = document.getElementById('pushBtn');

    function setStatus(msg, isError=false){
      elStatus.textContent = msg || '';
      elStatus.style.color = isError ? '#ef9a9a' : 'var(--subtle)';
    }
    function bindSyncUI(){
      elToken.value = SYNC.token || '';
      elGistId.value = SYNC.gistId || '';
      elFilename.value = SYNC.filename || 'imap-attendance.json';
      elAuto.checked = !!SYNC.auto;
      if (elCompact) {
        elCompact.checked = !!(STORE?.meta?.compact);
        document.body.classList.toggle('compact', elCompact.checked);
        elCompact.addEventListener('change', ()=>{ STORE.meta ||= {}; STORE.meta.compact = elCompact.checked; persist(); document.body.classList.toggle('compact', elCompact.checked); });
      }
      elToken.addEventListener('input', ()=>{ SYNC.token = elToken.value.trim(); saveSyncSettings(); });
      elGistId.addEventListener('input', ()=>{ SYNC.gistId = elGistId.value.trim(); saveSyncSettings(); });
      elFilename.addEventListener('input', ()=>{ SYNC.filename = elFilename.value.trim() || 'imap-attendance.json'; saveSyncSettings(); });
      elAuto.addEventListener('change', ()=>{ SYNC.auto = elAuto.checked; saveSyncSettings(); setupAutoSync(); });
      btnPull.addEventListener('click', ()=> pullNow().catch(err=> setStatus(err.message, true)) );
      btnPush.addEventListener('click', ()=> pushNow(true).catch(err=> setStatus(err.message, true)) );
    }

    async function api(path, opts={}){
      const token = SYNC.token?.trim();
      if(!token) throw new Error('Add your GitHub token');
      const res = await fetch(`${GITHUB_API}${path}`, {
        method: 'GET',
        headers: { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` },
        ...opts,
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`GitHub API ${res.status}: ${t}`);
      }
      return res.json();
    }
    async function gistPushUpdate(gistId, filename, content){ return api(`/gists/${gistId}`, { method: 'PATCH', body: JSON.stringify({ files: { [filename]: { content } } }) }); }
    async function gistCreate(filename, content){ return api(`/gists`, { method: 'POST', body: JSON.stringify({ description: 'iMAP Attendance Sheet data', public: false, files: { [filename]: { content } } }) }); }
    async function gistGet(gistId){ return api(`/gists/${gistId}`); }

    let dirtySince = 0; // timestamp when local changed since last push
    function payload(){ return JSON.stringify(STORE, null, 2); }

    async function pushNow(force=false){
      const filename = (SYNC.filename || 'imap-attendance.json').trim();
      if(!SYNC.token) throw new Error('Add your GitHub token');
      bumpMeta(); persist();
      const body = payload();
      if(SYNC.gistId){
        await gistPushUpdate(SYNC.gistId, filename, body);
        setStatus('Pushed to Gist');
      } else {
        const created = await gistCreate(filename, body);
        SYNC.gistId = created.id; elGistId.value = SYNC.gistId; saveSyncSettings();
        setStatus('Created new Gist and pushed');
      }
      dirtySince = 0;
    }

    async function pullNow(){
      if(!SYNC.token) throw new Error('Add your GitHub token');
      if(!SYNC.gistId) throw new Error('Add a Gist ID (or Push to create one)');
      const filename = (SYNC.filename || 'imap-attendance.json').trim();
      const g = await gistGet(SYNC.gistId);
      const file = g.files?.[filename];
      if(!file) throw new Error(`File not found in gist: ${filename}`);
      let text = file.content;
      if(file.truncated || !text){
        const raw = await fetch(file.raw_url);
        if(!raw.ok) throw new Error('Failed to fetch gist raw');
        text = await raw.text();
      }
      const incoming = JSON.parse(text);
      const remoteTs = incoming?.meta?.updatedAt || 0;
      const localTs = STORE?.meta?.updatedAt || 0;
      if(remoteTs <= localTs && !dirtySince){ setStatus('Already up to date'); return; }
      STORE = incoming; persist(); applyStoreToUI(); setStatus('Pulled from Gist'); dirtySince = 0;
    }

    async function smartSync(){
      try{
        if(!SYNC.auto) return;
        if(!SYNC.token || !SYNC.filename) return;
        if(!SYNC.gistId){ await pushNow(true); return; }
        const g = await gistGet(SYNC.gistId);
        const file = g.files?.[(SYNC.filename || 'imap-attendance.json').trim()];
        let text = file?.content;
        if(file?.truncated || !text){ const raw = await fetch(file.raw_url); text = await raw.text(); }
        const incoming = text ? JSON.parse(text) : null;
        const remoteTs = incoming?.meta?.updatedAt || 0;
        const localTs = STORE?.meta?.updatedAt || 0;
        if(remoteTs > localTs && (!dirtySince || remoteTs > dirtySince)){
          STORE = incoming; persist(); applyStoreToUI(); setStatus('Auto: pulled'); dirtySince = 0; return;
        }
        if(localTs > remoteTs){ await pushNow(true); setStatus('Auto: pushed'); return; }
      } catch(e){ setStatus('Auto sync error: '+e.message, true); }
    }

    let autoTimer = null;
    function setupAutoSync(){
      if(autoTimer) { clearInterval(autoTimer); autoTimer = null; }
      if(SYNC.auto){ autoTimer = setInterval(smartSync, 30000); }
    }

    function applyStoreToUI(){
      if(!CURRENT_BRANCH) return;
      renderUIForBranch();
      recomputeOverviewFromStore();
    }

    // ---------- Overview Tables (dynamic per branch) ----------
    function buildOverviewTables(){
      const wrap = document.getElementById('overviewTables');
      wrap.innerHTML = '';
      const order = BRANCHES[CURRENT_BRANCH].order;
      months.forEach(month => {
        const mId = idSafe(month);
        const table = el(`
          <div>
            <div class="month-title">${month}</div>
            <table>
              <thead>
                <tr>
                  <th></th>
                  ${order.map(k=>`<th>${classLabels[k]}</th>`).join('')}
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Present</td>
                  ${order.map(k=>`<td id="present-${k}-${mId}">0</td>`).join('')}
                  <td id="present-Total-${mId}">0</td>
                </tr>
                <tr>
                  <td>Absent</td>
                  ${order.map(k=>`<td id="absent-${k}-${mId}">0</td>`).join('')}
                  <td id="absent-Total-${mId}">0</td>
                </tr>
                <tr>
                  <td>Fees</td>
                  ${order.map(k=>`<td id="fees-${k}-${mId}">0</td>`).join('')}
                  <td id="fees-Total-${mId}">0</td>
                </tr>
              </tbody>
            </table>
          </div>
        `);
        wrap.appendChild(table);
      });
      recomputeOverviewFromStore();
    }

    function updateOverviewTotalsForMonth(month){
      const mId = idSafe(month);
      const order = BRANCHES[CURRENT_BRANCH].order;
      ["present","absent","fees"].forEach(type => {
        const sum = order.reduce((acc, k)=> acc + (parseFloat(document.getElementById(`${type}-${k}-${mId}`).textContent) || 0), 0);
        const totalCell = document.getElementById(`${type}-Total-${mId}`);
        if(totalCell) totalCell.textContent = sum;
      });
    }

    // ---------- Branch-driven UI ----------
    const TYPE_OPTIONS = ["", "New", "Renewal", "Revival", "Carry-Forward", "Shift in Carry-Forward"];

    function renderUIForBranch(){
      const tabsEl = document.querySelector('.tabs');
      const order = BRANCHES[CURRENT_BRANCH].order;
      tabsEl.innerHTML = ['overview', ...order].map(id => {
        const label = id === 'overview' ? 'Overview' : classLabels[id];
        return `<button class="tab-btn${id==='overview'?' active':''}" data-tab="${id}">${label}</button>`;
      }).join('');

      const panels = document.getElementById('panels');
      panels.innerHTML = `
        <section id="overview" class="panel active"><div class="grid"><div id="overviewTables"></div></div></section>
        ${order.map(k => `<section id="${k}" class="panel"></section>`).join('')}
      `;

      // Show app chrome and Back button
      document.querySelector('.tabs').classList.remove('hidden');
      document.querySelector('.sync-bar').classList.remove('hidden');
      document.getElementById('panels').classList.remove('hidden');
      document.getElementById('topbar').classList.add('show');

      buildOverviewTables();
      order.forEach(buildClassPanel);
    }

    function setBranch(branch){
      CURRENT_BRANCH = branch;
      classLabels = { ...BRANCHES[branch].labels };
      CLASS_CONFIGS = {};
      for(const [k, cfg] of Object.entries(BRANCHES[branch].configs)){
        CLASS_CONFIGS[k] = { label: classLabels[k], allowedDays: cfg.allowedDays };
      }
      document.getElementById('branchGate').classList.add('hidden');
      renderUIForBranch();
    }

    function goBackToBranches(){
      CURRENT_BRANCH = null;
      document.getElementById('branchGate').classList.remove('hidden');
      document.querySelector('.tabs').classList.add('hidden');
      document.querySelector('.sync-bar').classList.add('hidden');
      document.getElementById('panels').classList.add('hidden');
      document.getElementById('topbar').classList.remove('show');
      // Clear tabs/panels so the next branch renders fresh
      document.querySelector('.tabs').innerHTML = '';
      document.getElementById('panels').innerHTML = '';
    }

    function buildClassPanel(classKey){
      const cfg = CLASS_CONFIGS[classKey];
      const panel = document.getElementById(classKey);
      const monthOptions = months.map(m=>`<option>${m}</option>`).join('');
      panel.innerHTML = `
        <div class="controls">
          <label><strong>${cfg.label}</strong></label>
          <label>Month: <select id="monthSelect-${classKey}">${monthOptions}</select></label>
          <label><input type="checkbox" id="collapseToggle-${classKey}" /> Collapse attendance</label>
        </div>
        <div id="classTableContainer-${classKey}"></div>
      `;

      const select = document.getElementById(`monthSelect-${classKey}`);
      const selMap = getBranchSelectedMonths();
      if(selMap && selMap[classKey]){
        const saved = selMap[classKey];
        if([...select.options].some(o=>o.value===saved)){ select.value = saved; }
      }
      select.addEventListener('change', ()=> { generateClassTable(classKey); saveCurrentClassState(classKey); });
      generateClassTable(classKey);

      const collapseToggle = document.getElementById(`collapseToggle-${classKey}`);
      if (collapseToggle) {
        const pref = !!(getCollapsePrefs()?.[classKey]);
        collapseToggle.checked = pref;
        const tbl0 = document.getElementById(`classTable-${classKey}`);
        if (tbl0 && pref) tbl0.classList.add('collapsed');
        collapseToggle.addEventListener('change', (e)=>{
          const tbl = document.getElementById(`classTable-${classKey}`);
          if (tbl) tbl.classList.toggle('collapsed', e.target.checked);
          const c = getCollapsePrefs(); c[classKey] = e.target.checked; persist();
        });
      }
    }

    function validTillLabelSeq(startMonthIdx, startYear){
      const items = [];
      for(let i=0;i<12;i++){
        const mIdx = (startMonthIdx + i) % 12;
        const y = startYear + Math.floor((startMonthIdx + i)/12);
        items.push({mIdx, y});
      }
      const firstY = items[0].y, lastY = items[items.length-1].y;
      const sameYear = firstY === lastY;
      return items.map(({mIdx,y})=>{
        const short = new Date(y, mIdx, 1).toLocaleString('en-US',{month:'short'});
        return {value:`${y}-${mIdx+1}`, label: sameYear ? short : `${short} ${y}`};
      });
    }

    function getDaysInMonthByWeekdays(monthIndex, year, allowedDays){
      const days = [];
      const d = new Date(year, monthIndex, 1);
      while(d.getMonth() === monthIndex){
        if(allowedDays.includes(d.getDay())){
          const label = `${d.getDate()}/${d.getMonth()+1}`;
          days.push({date: new Date(d), label});
        }
        d.setDate(d.getDate()+1);
      }
      return days;
    }

    function el(html){
      const t = document.createElement('template');
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }

    function sanitizeNumber(raw){
      if(typeof raw !== 'string') raw = String(raw ?? '');
      const m = raw.replace(/,/g,'').match(/\d+(?:\.\d+)?/);
      return m ? parseFloat(m[0]) : 0;
    }

    function attachPhoneValidation(input){
      input.classList.add('phone');
      input.setAttribute('inputmode','numeric');
      input.addEventListener('input', ()=>{
        const digits = input.value.replace(/\D/g,'').slice(0,10);
        input.value = digits;
        if(digits.length===0){ input.classList.remove('invalid'); return; }
        if(digits.length!==10){ input.classList.add('invalid'); }
        else { input.classList.remove('invalid'); }
      });
      input.addEventListener('blur', ()=>{
        const digits = input.value.replace(/\D/g,'');
        if(digits.length!==0 && digits.length!==10){ input.classList.add('invalid'); }
      });
    }

    function autoResizeTA(ta){
      const handler = ()=>{ ta.style.height='auto'; ta.style.height = (ta.scrollHeight+2)+'px'; };
      ta.addEventListener('input', handler); handler();
    }

    function generateClassTable(classKey){
      const cfg = CLASS_CONFIGS[classKey];
      const monthStr = document.getElementById(`monthSelect-${classKey}`).value;
      const [monthName, yearStr] = monthStr.split(' ');
      const year = parseInt(yearStr, 10);
      const monthIndex = new Date(`${monthName} 1, ${year}`).getMonth();
      const days = getDaysInMonthByWeekdays(monthIndex, year, cfg.allowedDays);

      let html = `<table id="classTable-${classKey}">`;
      html += `<thead><tr><th>Student Name</th><th>Phone No.</th>`;
      days.forEach(d => { html += `<th class="day-col">${d.label}</th>`; });
      html += `<th>Fees Paid</th><th>Type</th><th>Valid Till</th><th>Notes</th></tr>`;
      html += `<tr class="day-row"><th></th><th></th>`;
      days.forEach(d => { html += `<th class="day-col">${['SUN','MON','TUE','WED','THU','FRI','SAT'][d.date.getDay()]}</th>`; });
      html += `<th></th><th></th><th></th><th></th></tr></thead><tbody>`;

      for(let r=1; r<=15; r++){
        html += `<tr>`;
        html += `<td><input type="text" placeholder="Student ${r}"></td>`;
        html += `<td><input type="text" class="phone" placeholder="" /></td>`;
        days.forEach(()=>{
          html += `<td class="day-col"><select>
            <option value=""> </option>
            <option value="Present">Present</option>
            <option value="Absent">Absent</option>
            <option value="Drop-in">Drop-in</option>
          </select></td>`;
        });
        html += `<td><input type="text" class="fee" placeholder="" /></td>`;
        html += `<td><select class="type">
          ${TYPE_OPTIONS.map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
        </select></td>`;
        html += `<td><select class="validTill"><option value=""></option></select></td>`;
        html += `<td><textarea rows="1" placeholder=""></textarea></td>`;
        html += `</tr>`;
      }
      html += `</tbody><tfoot><tr><td><strong>Total Fees</strong></td><td></td><td colspan="${days.length}"></td><td id="classTotal-${classKey}">0</td><td></td><td></td><td></td></tr></tfoot></table>`;

      const container = document.getElementById(`classTableContainer-${classKey}`);
      container.innerHTML = html;

      const tblApply = document.getElementById(`classTable-${classKey}`);
      if (getCollapsePrefs()?.[classKey]) tblApply.classList.add('collapsed');

      container.querySelectorAll('input.phone').forEach(inp=> attachPhoneValidation(inp));
      container.querySelectorAll('textarea').forEach(ta=> autoResizeTA(ta));
      container.querySelectorAll('input[type="text"], textarea, select').forEach(elm => {
        elm.addEventListener('change', ()=> { updateClassTotals(classKey); saveCurrentClassState(classKey); });
        elm.addEventListener('input',  ()=> { updateClassTotals(classKey); saveCurrentClassState(classKey); });
      });

      refreshValidTillOptionsFor(classKey, monthIndex, year);
      restoreClassTable(classKey);
      updateClassTotals(classKey);
    }

    function refreshValidTillOptionsFor(classKey, monthIndex, year){
      const table = document.getElementById(`classTable-${classKey}`);
      if(!table) return;
      const options = validTillLabelSeq(monthIndex, year);
      const selects = table.querySelectorAll('select.validTill');
      selects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = `<option value=""></option>` + options.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
        if(current) {
          const opt = sel.querySelector(\`option[value="${current}"]\`);
          if(opt) sel.value = current; else sel.value = '';
        }
      });
    }

    function updateClassTotals(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      if(!table) return;
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);

      let present = 0, absent = 0, feesTotal = 0;

      table.querySelectorAll('tbody tr').forEach(row => {
        const feeRaw = row.querySelector('input.fee')?.value || '';
        const feeVal = sanitizeNumber(feeRaw);
        feesTotal += feeVal;

        row.querySelectorAll('select:not(.type):not(.validTill)').forEach(sel => {
          const v = sel.value;
          if(v === 'Present' || v === 'Drop-in'){ present++; }
          else if(v === 'Absent') { absent++; }
        });
      });

      const classTotalCell = document.getElementById(`classTotal-${classKey}`);
      if(classTotalCell) classTotalCell.textContent = feesTotal;

      const pCell = document.getElementById(`present-${classKey}-${mId}`);
      const aCell = document.getElementById(`absent-${classKey}-${mId}`);
      const fCell = document.getElementById(`fees-${classKey}-${mId}`);
      if(pCell) pCell.textContent = present;
      if(aCell) aCell.textContent = absent;
      if(fCell) fCell.textContent = feesTotal;

      updateOverviewTotalsForMonth(month);
    }

    // Event delegation for tabs, branch select, and back
    document.body.addEventListener('click', (e)=>{
      const tab = e.target.closest('.tab-btn');
      if(tab){
        const toId = tab.dataset.tab;
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.toggle('active', b===tab));
        document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id===toId));
        return;
      }
      const branchBtn = e.target.closest('button[data-branch]');
      if(branchBtn){ setBranch(branchBtn.dataset.branch); return; }
      const back = e.target.closest('#backBtn');
      if(back){ goBackToBranches(); return; }
    });

    // Bind sync UI & auto sync
    bindSyncUI();
    setupAutoSync();
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) smartSync(); });

    // Smoke test
    (function runTests(){
      try {
        console.assert(Array.isArray(months) && months.length >= 1, 'months should be a non-empty array');
        console.log('%ciMAP: ready. Pick a branch.', 'color:#7cc4ff');
      } catch (e) { console.error('Test failure:', e); }
    })();
  </script>
</body>
</html>
