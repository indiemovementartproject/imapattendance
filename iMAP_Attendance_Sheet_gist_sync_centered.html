<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iMAP Attendance Sheet</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0f14;
      --card: #10161d;
      --border: #1f2a36;
      --muted: #0f1a24;
      --text: #f5f7fa;
      --subtle: #c9d4e1;
      --accent: #7cc4ff; /* light blue highlight */
      --danger:#ef4444;
      --sticky1: 220px; /* Student column width */
      --sticky2: 140px; /* Phone column width */
    }
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--border); background: var(--card); position: sticky; top: 0; z-index: 10; display: flex; justify-content: center; align-items: center; text-align: center; }
    h1 { margin: 0; font-size: 20px; font-weight: 600; color: var(--text); }

    .wrap { padding: 16px 20px; }
    .tabs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px; overflow-x: auto; -webkit-overflow-scrolling: touch; justify-content: center; }
    .tab-btn { appearance: none; border: 1px solid var(--border); background: var(--card); color: var(--subtle); padding: 8px 12px; border-radius: 10px; cursor: pointer; font-family: inherit; font-weight: 500; }
    .tab-btn:hover { border-color: var(--accent); color: var(--text); }
    .tab-btn.active { background: var(--accent); color: #00131f; border-color: var(--accent); }

    .panel { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 12px; overflow-x: auto; }
    .panel.active { display: block; }

    table { border-collapse: collapse; margin: 8px auto; background: var(--card); }
    th, td { border: 1px solid var(--border); padding: 6px; text-align: center; font-size: 13px; vertical-align: top; color: var(--text); white-space: nowrap; }
    thead th { background: #0f1a24; font-weight: 600; position: sticky; top: 0; z-index: 3; }
    thead tr.day-row th { background: #0b141b; font-weight: 500; font-size: 11px; }
    tfoot td { background: #0f1a24; font-weight: 600; }

    /* Widths ONLY (no sticky columns) for class tables */
    table[id^="classTable-"] th:first-child,
    table[id^="classTable-"] td:first-child { width: var(--sticky1); text-align: center; }

    table[id^="classTable-"] th:nth-child(2),
    table[id^="classTable-"] td:nth-child(2) { width: var(--sticky2); }

    /* Overview tables: compact columns & extra padding */
    #overviewTables table { table-layout: auto; margin: 8px auto; }
    #overviewTables table th, #overviewTables table td { width: auto; padding: 5px; }

    .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; color: var(--subtle); justify-content: center; }
    .controls label { font-size: 12px; }
    select, input[type="text"], textarea, input[type="password"] { padding: 6px 8px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 13px; background: #0b141b; color: var(--text); }
    select:focus, input[type="text"]:focus, input[type="password"]:focus, textarea:focus { outline: 2px solid var(--accent); outline-offset: 0; border-color: var(--accent); }
    input[type="text"], textarea, input[type="password"] { width: 100%; }
    textarea { resize: vertical; min-height: 30px; }

    .phone.invalid { border-color: var(--danger); box-shadow: 0 0 0 2px rgba(239,68,68,.15); }

    .grid { display: grid; gap: 12px; }
    .month-title { margin: 8px 0 2px; font-size: 14px; font-weight: 600; color: var(--accent); text-align: center; }

    /* Compact selects in attendance grid */
    td select { width: 100%; min-width: 80px; }
    td input.fee { text-align: right; }

    /* Persist & Sync bars */
    .persist-bar, .sync-bar { display:flex; gap:8px; align-items:center; margin: 6px 0; flex-wrap: wrap; justify-content: center; }
    .persist-bar .btn, .sync-bar .btn { border:1px solid var(--border); background: var(--card); color: var(--subtle); padding:6px 10px; border-radius:8px; cursor:pointer; font-family:inherit; font-size:12px; }
    .persist-bar .btn:hover, .sync-bar .btn:hover { border-color: var(--accent); color: var(--text); }
    .persist-bar input[type=file] { display:none; }
    .sync-bar input[type="text"], .sync-bar input[type="password"] { width: 220px; }
    .sync-bar .status { font-size: 12px; color: var(--subtle); min-width: 160px; text-align: center; }

    /* Mobile-friendly tweaks */
    @media (max-width: 768px) {
      .wrap { padding: 12px; }
      h1 { font-size: 18px; }
      .tabs { flex-wrap: nowrap; }
      .tab-btn { padding: 8px 10px; font-size: 12px; }
      th, td { padding: 4px; font-size: 12px; }
      td select { min-width: 64px; }
      .controls { flex-direction: column; align-items: center; gap: 8px; }
      .controls label select, .controls label input { width: 100%; }
      .sync-bar input[type="text"], .sync-bar input[type="password"] { width: 100%; max-width: 280px; }
    }

    /* Center overview tables within the Overview panel */
    #overview .grid { justify-items: center; }
  </style>
</head>
<body>
  <header>
    <h1>iMAP Attendance Sheet</h1>
  </header>

  <div class="wrap">
    <div class="tabs">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="JazzTraining">Jazz Training</button>
      <button class="tab-btn" data-tab="JazzFunk">Jazz Funk</button>
      <button class="tab-btn" data-tab="BollywoodWeekends">Bollywood Weekends</button>
      <button class="tab-btn" data-tab="BalletTraining">Ballet Training</button>
    </div>

    <div class="persist-bar">
      <button id="exportBtn" class="btn">Export Data</button>
      <label for="importFile" class="btn">Import Data</label>
      <input id="importFile" type="file" accept="application/json" />
      <span style="font-size:12px;color:var(--subtle)">Autosaves in your browser â€¢ Use Export/Import to move across devices</span>
    </div>

    <div class="sync-bar">
      <input id="ghToken" type="password" placeholder="GitHub Token (gist scope)" />
      <input id="gistId" type="text" placeholder="Gist ID (leave blank to create)" />
      <input id="gistFilename" type="text" placeholder="Filename" value="imap-attendance.json" />
      <label style="font-size:12px;color:var(--subtle)"><input id="autoSync" type="checkbox" style="vertical-align:middle;margin-right:6px;"/>Auto Sync</label>
      <button id="pullBtn" class="btn">Pull</button>
      <button id="pushBtn" class="btn">Push</button>
      <span id="syncStatus" class="status"></span>
    </div>

    <!-- Overview Panel -->
    <section id="overview" class="panel active">
      <div class="grid">
        <div id="overviewTables"></div>
      </div>
    </section>

    <!-- Class Panels -->
    <section id="JazzTraining" class="panel"></section>
    <section id="JazzFunk" class="panel"></section>
    <section id="BollywoodWeekends" class="panel"></section>
    <section id="BalletTraining" class="panel"></section>
  </div>

  <!-- All JS contained in a single module to avoid global redeclarations -->
  <script type="module">
    // ---------------- Config ----------------
    const months = ["August 2025","September 2025","October 2025","November 2025","December 2025"];
    const classLabels = {
      JazzTraining: "Jazz Training",
      JazzFunk: "Jazz Funk",
      BollywoodWeekends: "Bollywood Weekends",
      BalletTraining: "Ballet Training"
    };

    // Safe id helper (avoid spaces in id attributes)
    const idSafe = (s) => String(s).replace(/\s+/g, '_');

    // ---------------- Persistence ----------------
    const STORAGE_KEY = 'imap-attendance-v1';
    function loadStore(){
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        const parsed = raw ? JSON.parse(raw) : null;
        return parsed && typeof parsed === 'object' ? parsed : {version:1, selectedMonths:{}, data:{}, meta:{updatedAt:0}};
      } catch(e){
        console.error('Store load failed', e); return {version:1, selectedMonths:{}, data:{}, meta:{updatedAt:0}};
      }
    }
    let STORE = loadStore();
    function persist(){
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(STORE)); }
      catch(e){ console.error('Store save failed', e); }
    }

    // Mark dirty + timestamp
    function bumpMeta(){
      STORE.meta ||= {}; STORE.meta.updatedAt = Date.now(); STORE.meta.deviceId = getDeviceId();
    }

    function saveCurrentClassState(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);
      if(!table) return;
      const rows = [];
      table.querySelectorAll('tbody tr').forEach(tr => {
        const tds = [...tr.children];
        const name = tds[0].querySelector('input')?.value || '';
        const phone = tds[1].querySelector('input')?.value || '';
        // day selects are from index 2 up to before fee cell
        const daySelects = tds.slice(2, -4).map(td=> td.querySelector('select'));
        const days = daySelects.map(sel => sel ? sel.value : '');
        const fee = tds[tds.length-4].querySelector('input')?.value || '';
        const type = tds[tds.length-3].querySelector('select')?.value || '';
        const validTill = tds[tds.length-2].querySelector('select')?.value || '';
        const notes = tds[tds.length-1].querySelector('textarea')?.value || '';
        rows.push({name, phone, days, fee, type, validTill, notes});
      });
      STORE.data ||= {}; STORE.data[classKey] ||= {}; STORE.data[classKey][mId] = rows;
      STORE.selectedMonths ||= {}; STORE.selectedMonths[classKey] = month;
      bumpMeta();
      persist();
      recomputeOverviewFromStore();
      dirtySince = STORE.meta.updatedAt;
    }

    function restoreClassTable(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);
      const rows = STORE?.data?.[classKey]?.[mId] || [];
      if(!table || rows.length===0) return;
      const bodyRows = [...table.querySelectorAll('tbody tr')];
      bodyRows.forEach((tr, idx) => {
        const data = rows[idx]; if(!data) return;
        const tds = [...tr.children];
        if(tds[0]) tds[0].querySelector('input').value = data.name ?? '';
        if(tds[1]) tds[1].querySelector('input').value = data.phone ?? '';
        const dayCells = tds.slice(2, -4);
        for(let i=0;i<dayCells.length;i++){
          const sel = dayCells[i].querySelector('select');
          if(!sel) continue;
          const val = (data.days && data.days[i]) || '';
          sel.value = [...sel.options].some(o=>o.value===val) ? val : '';
        }
        tds[tds.length-4].querySelector('input').value = data.fee ?? '';
        tds[tds.length-3].querySelector('select').value = data.type ?? '';
        tds[tds.length-2].querySelector('select').value = data.validTill ?? '';
        tds[tds.length-1].querySelector('textarea').value = data.notes ?? '';
      });
    }

    function recomputeOverviewFromStore(){
      months.forEach(month => {
        const mId = idSafe(month);
        let present=0, absent=0, fees=0;
        for(const classKey of Object.keys(classLabels)){
          const rows = STORE?.data?.[classKey]?.[mId] || [];
          rows.forEach(r => {
            (r.days||[]).forEach(v=>{ if(v==='Present'||v==='Drop-in') present++; else if(v==='Absent') absent++; });
            fees += sanitizeNumber(r.fee||0);
          });
          const pCell = document.getElementById(`present-${classKey}-${mId}`);
          const aCell = document.getElementById(`absent-${classKey}-${mId}`);
          const fCell = document.getElementById(`fees-${classKey}-${mId}`);
          if(pCell) pCell.textContent = rows.reduce((acc, r)=> acc + (r.days||[]).filter(v=>v==='Present'||v==='Drop-in').length, 0);
          if(aCell) aCell.textContent = rows.reduce((acc, r)=> acc + (r.days||[]).filter(v=>v==='Absent').length, 0);
          if(fCell) fCell.textContent = rows.reduce((acc, r)=> acc + sanitizeNumber(r.fee||0), 0);
        }
        const tP = document.getElementById(`present-Total-${mId}`);
        const tA = document.getElementById(`absent-Total-${mId}`);
        const tF = document.getElementById(`fees-Total-${mId}`);
        if(tP) tP.textContent = present;
        if(tA) tA.textContent = absent;
        if(tF) tF.textContent = fees;
      });
    }

    // ---------- GitHub Gist Sync ----------
    const SYNC_KEY = 'imap-sync-settings';
    const GITHUB_API = 'https://api.github.com';
    let SYNC = loadSyncSettings();
    function loadSyncSettings(){
      try { return JSON.parse(localStorage.getItem(SYNC_KEY)) || {}; } catch { return {}; }
    }
    function saveSyncSettings(){ localStorage.setItem(SYNC_KEY, JSON.stringify(SYNC)); }
    function getDeviceId(){
      SYNC.deviceId ||= (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
      saveSyncSettings();
      return SYNC.deviceId;
    }

    const elToken = document.getElementById('ghToken');
    const elGistId = document.getElementById('gistId');
    const elFilename = document.getElementById('gistFilename');
    const elAuto = document.getElementById('autoSync');
    const elStatus = document.getElementById('syncStatus');
    const btnPull = document.getElementById('pullBtn');
    const btnPush = document.getElementById('pushBtn');

    function setStatus(msg, isError=false){
      elStatus.textContent = msg || '';
      elStatus.style.color = isError ? '#ef9a9a' : 'var(--subtle)';
    }

    function bindSyncUI(){
      elToken.value = SYNC.token || '';
      elGistId.value = SYNC.gistId || '';
      elFilename.value = SYNC.filename || 'imap-attendance.json';
      elAuto.checked = !!SYNC.auto;
      elToken.addEventListener('input', ()=>{ SYNC.token = elToken.value.trim(); saveSyncSettings(); });
      elGistId.addEventListener('input', ()=>{ SYNC.gistId = elGistId.value.trim(); saveSyncSettings(); });
      elFilename.addEventListener('input', ()=>{ SYNC.filename = elFilename.value.trim() || 'imap-attendance.json'; saveSyncSettings(); });
      elAuto.addEventListener('change', ()=>{ SYNC.auto = elAuto.checked; saveSyncSettings(); setupAutoSync(); });
      btnPull.addEventListener('click', ()=> pullNow().catch(err=> setStatus(err.message, true)) );
      btnPush.addEventListener('click', ()=> pushNow(true).catch(err=> setStatus(err.message, true)) );
    }

    async function api(path, opts={}){
      const token = SYNC.token?.trim();
      if(!token) throw new Error('Add your GitHub token');
      const res = await fetch(`${GITHUB_API}${path}`, {
        method: 'GET',
        headers: { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` },
        ...opts,
      });
      if(!res.ok){
        const t = await res.text();
        throw new Error(`GitHub API ${res.status}: ${t}`);
      }
      return res.json();
    }

    async function gistPushUpdate(gistId, filename, content){
      return api(`/gists/${gistId}`, {
        method: 'PATCH',
        body: JSON.stringify({ files: { [filename]: { content } } })
      });
    }
    async function gistCreate(filename, content){
      return api(`/gists`, {
        method: 'POST',
        body: JSON.stringify({ description: 'iMAP Attendance Sheet data', public: false, files: { [filename]: { content } } })
      });
    }
    async function gistGet(gistId){
      return api(`/gists/${gistId}`);
    }

    let dirtySince = 0; // timestamp when local changed since last push

    function payload(){
      return JSON.stringify(STORE, null, 2);
    }

    async function pushNow(force=false){
      const filename = (SYNC.filename || 'imap-attendance.json').trim();
      if(!SYNC.token) throw new Error('Add your GitHub token');
      bumpMeta(); persist(); // ensure updatedAt is fresh
      const body = payload();
      if(SYNC.gistId){
        await gistPushUpdate(SYNC.gistId, filename, body);
        setStatus('Pushed to Gist');
      } else {
        const created = await gistCreate(filename, body);
        SYNC.gistId = created.id; elGistId.value = SYNC.gistId; saveSyncSettings();
        setStatus('Created new Gist and pushed');
      }
      dirtySince = 0;
    }

    async function pullNow(){
      if(!SYNC.token) throw new Error('Add your GitHub token');
      if(!SYNC.gistId) throw new Error('Add a Gist ID (or Push to create one)');
      const filename = (SYNC.filename || 'imap-attendance.json').trim();
      const g = await gistGet(SYNC.gistId);
      const file = g.files?.[filename];
      if(!file) throw new Error(`File not found in gist: ${filename}`);
      // Prefer embedded content; fallback to raw_url fetch
      let text = file.content;
      if(file.truncated || !text){
        const raw = await fetch(file.raw_url);
        if(!raw.ok) throw new Error('Failed to fetch gist raw');
        text = await raw.text();
      }
      const incoming = JSON.parse(text);
      const remoteTs = incoming?.meta?.updatedAt || 0;
      const localTs = STORE?.meta?.updatedAt || 0;
      if(remoteTs <= localTs && !dirtySince){ setStatus('Already up to date'); return; }
      STORE = incoming; persist();
      applyStoreToUI();
      setStatus('Pulled from Gist');
      dirtySince = 0;
    }

    async function smartSync(){
      try{
        if(!SYNC.auto) return;
        if(!SYNC.token || !SYNC.filename) return;
        if(!SYNC.gistId){ await pushNow(true); return; }
        // Compare timestamps
        const g = await gistGet(SYNC.gistId);
        const file = g.files?.[(SYNC.filename || 'imap-attendance.json').trim()];
        let text = file?.content;
        if(file?.truncated || !text){
          const raw = await fetch(file.raw_url); text = await raw.text();
        }
        const incoming = text ? JSON.parse(text) : null;
        const remoteTs = incoming?.meta?.updatedAt || 0;
        const localTs = STORE?.meta?.updatedAt || 0;
        if(remoteTs > localTs && (!dirtySince || remoteTs > dirtySince)){
          STORE = incoming; persist(); applyStoreToUI(); setStatus('Auto: pulled'); dirtySince = 0; return;
        }
        if(localTs > remoteTs){ await pushNow(true); setStatus('Auto: pushed'); return; }
      } catch(e){ setStatus('Auto sync error: '+e.message, true); }
    }

    let autoTimer = null;
    function setupAutoSync(){
      if(autoTimer) { clearInterval(autoTimer); autoTimer = null; }
      if(SYNC.auto){ autoTimer = setInterval(smartSync, 30000); }
    }

    function applyStoreToUI(){
      buildOverviewTables();
      ["JazzTraining","JazzFunk","BollywoodWeekends","BalletTraining"].forEach(classKey=>{
        const sel = document.getElementById(`monthSelect-${classKey}`);
        if(sel && STORE?.selectedMonths?.[classKey]){
          const saved = STORE.selectedMonths[classKey];
          if([...sel.options].some(o=>o.value===saved)) sel.value = saved;
        }
        generateClassTable(classKey);
      });
      recomputeOverviewFromStore();
    }

    // ---------- Utilities ----------
    function switchTab(toId){
      document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.toggle('active', btn.dataset.tab===toId));
      document.querySelectorAll('.panel').forEach(p=>p.classList.toggle('active', p.id===toId));
    }
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=> switchTab(btn.dataset.tab));
    });

    function getDaysInMonthByWeekdays(monthIndex, year, allowedDays){
      const days = [];
      const d = new Date(year, monthIndex, 1);
      while(d.getMonth() === monthIndex){
        if(allowedDays.includes(d.getDay())){
          const label = `${d.getDate()}/${d.getMonth()+1}`; // D/M
          days.push({date: new Date(d), label});
        }
        d.setDate(d.getDate()+1);
      }
      return days; // chronological
    }

    function el(html){
      const t = document.createElement('template');
      t.innerHTML = html.trim();
      return t.content.firstElementChild;
    }

    // Numeric sanitizer: returns first number found (int/decimal), else 0
    function sanitizeNumber(raw){
      if(typeof raw !== 'string') raw = String(raw ?? '');
      const m = raw.replace(/,/g,'').match(/\d+(?:\.\d+)?/);
      return m ? parseFloat(m[0]) : 0;
    }

    // Phone validation: digits only, 10 max; blank is OK
    function attachPhoneValidation(input){
      input.classList.add('phone');
      input.setAttribute('inputmode','numeric');
      input.addEventListener('input', ()=>{
        const digits = input.value.replace(/\D/g,'').slice(0,10);
        input.value = digits;
        if(digits.length===0){ input.classList.remove('invalid'); return; }
        if(digits.length!==10){ input.classList.add('invalid'); }
        else { input.classList.remove('invalid'); }
      });
      input.addEventListener('blur', ()=>{
        const digits = input.value.replace(/\D/g,'');
        if(digits.length!==0 && digits.length!==10){ input.classList.add('invalid'); }
      });
    }

    // Auto-resize textarea
    function autoResizeTA(ta){
      const handler = ()=>{ ta.style.height='auto'; ta.style.height = (ta.scrollHeight+2)+'px'; };
      ta.addEventListener('input', handler); handler();
    }

    // ---------- Overview Tables (one per month) ----------
    function buildOverviewTables(){
      const wrap = document.getElementById('overviewTables');
      wrap.innerHTML = '';
      months.forEach(month => {
        const mId = idSafe(month);
        const table = el(`
          <div>
            <div class="month-title">${month}</div>
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>${classLabels.JazzTraining}</th>
                  <th>${classLabels.JazzFunk}</th>
                  <th>${classLabels.BollywoodWeekends}</th>
                  <th>${classLabels.BalletTraining}</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Present</td>
                  <td id="present-JazzTraining-${mId}">0</td>
                  <td id="present-JazzFunk-${mId}">0</td>
                  <td id="present-BollywoodWeekends-${mId}">0</td>
                  <td id="present-BalletTraining-${mId}">0</td>
                  <td id="present-Total-${mId}">0</td>
                </tr>
                <tr>
                  <td>Absent</td>
                  <td id="absent-JazzTraining-${mId}">0</td>
                  <td id="absent-JazzFunk-${mId}">0</td>
                  <td id="absent-BollywoodWeekends-${mId}">0</td>
                  <td id="absent-BalletTraining-${mId}">0</td>
                  <td id="absent-Total-${mId}">0</td>
                </tr>
                <tr>
                  <td>Fees</td>
                  <td id="fees-JazzTraining-${mId}">0</td>
                  <td id="fees-JazzFunk-${mId}">0</td>
                  <td id="fees-BollywoodWeekends-${mId}">0</td>
                  <td id="fees-BalletTraining-${mId}">0</td>
                  <td id="fees-Total-${mId}">0</td>
                </tr>
              </tbody>
            </table>
          </div>
        `);
        wrap.appendChild(table);
      });
      // After building the structure, paint values from STORE
      recomputeOverviewFromStore();
    }

    function updateOverviewTotalsForMonth(month){
      const mId = idSafe(month);
      ["present","absent","fees"].forEach(type => {
        const j = parseFloat(document.getElementById(`${type}-JazzTraining-${mId}`).textContent) || 0;
        const jf = parseFloat(document.getElementById(`${type}-JazzFunk-${mId}`).textContent) || 0;
        const bw = parseFloat(document.getElementById(`${type}-BollywoodWeekends-${mId}`).textContent) || 0;
        const bt = parseFloat(document.getElementById(`${type}-BalletTraining-${mId}`).textContent) || 0;
        const totalCell = document.getElementById(`${type}-Total-${mId}`);
        totalCell.textContent = j + jf + bw + bt;
      });
    }

    // ---------- Class Tab Factory ----------
    const CLASS_CONFIGS = {
      JazzTraining: { label: classLabels.JazzTraining, allowedDays: [0] }, // Sundays
      JazzFunk: { label: classLabels.JazzFunk, allowedDays: [0] }, // Sundays
      BollywoodWeekends: { label: classLabels.BollywoodWeekends, allowedDays: [6,0] }, // Sat & Sun
      BalletTraining: { label: classLabels.BalletTraining, allowedDays: [6] } // Saturdays
    };

    const TYPE_OPTIONS = ["", "New", "Renewal", "Revival", "Carry-Forward", "Shift in Carry-Forward"];

    function buildClassPanel(classKey){
      const cfg = CLASS_CONFIGS[classKey];
      const panel = document.getElementById(classKey);
      const monthOptions = months.map(m=>`<option>${m}</option>`).join('');
      panel.innerHTML = `
        <div class="controls">
          <label><strong>${cfg.label}</strong></label>
          <label>Month: <select id="monthSelect-${classKey}">${monthOptions}</select></label>
        </div>
        <div id="classTableContainer-${classKey}"></div>
      `;

      const select = document.getElementById(`monthSelect-${classKey}`);
      // Restore previously selected month if present
      if(STORE?.selectedMonths?.[classKey]){
        const saved = STORE.selectedMonths[classKey];
        if([...select.options].some(o=>o.value===saved)){ select.value = saved; }
      }
      select.addEventListener('change', ()=> { generateClassTable(classKey); saveCurrentClassState(classKey); });
      generateClassTable(classKey); // initial
    }

    function validTillLabelSeq(startMonthIdx, startYear){
      // Return array of 12 labels from selected month onward. Hide year if all in same year.
      const items = [];
      for(let i=0;i<12;i++){
        const mIdx = (startMonthIdx + i) % 12;
        const y = startYear + Math.floor((startMonthIdx + i)/12);
        items.push({mIdx, y});
      }
      const firstY = items[0].y, lastY = items[items.length-1].y;
      const sameYear = firstY === lastY;
      return items.map(({mIdx,y})=>{
        const short = new Date(y, mIdx, 1).toLocaleString('en-US',{month:'short'});
        return {value:`${y}-${mIdx+1}`, label: sameYear ? short : `${short} ${y}`};
      });
    }

    function generateClassTable(classKey){
      const cfg = CLASS_CONFIGS[classKey];
      const monthStr = document.getElementById(`monthSelect-${classKey}`).value; // e.g., "August 2025"
      const [monthName, yearStr] = monthStr.split(' ');
      const year = parseInt(yearStr, 10);
      const monthIndex = new Date(`${monthName} 1, ${year}`).getMonth();
      const days = getDaysInMonthByWeekdays(monthIndex, year, cfg.allowedDays);

      let html = `<table id="classTable-${classKey}">`;
      // Header row 1: date labels
      html += `<thead><tr><th>Student Name</th><th>Phone No.</th>`;
      days.forEach(d => { html += `<th>${d.label}</th>`; });
      html += `<th>Fees Paid</th><th>Type</th><th>Valid Till</th><th>Notes</th></tr>`;
      // Header row 2: day short forms
      html += `<tr class="day-row"><th></th><th></th>`;
      days.forEach(d => { html += `<th>${['SUN','MON','TUE','WED','THU','FRI','SAT'][d.date.getDay()]}</th>`; });
      html += `<th></th><th></th><th></th><th></th></tr></thead><tbody>`;

      for(let r=1; r<=15; r++){
        html += `<tr>`;
        html += `<td><input type="text" placeholder="Student ${r}"></td>`;
        html += `<td><input type="text" class="phone" placeholder="" /></td>`;
        days.forEach(()=>{
          html += `<td><select>
            <option value=""> </option>
            <option value="Present">Present</option>
            <option value="Absent">Absent</option>
            <option value="Drop-in">Drop-in</option>
          </select></td>`;
        });
        html += `<td><input type="text" class="fee" placeholder="" /></td>`;
        html += `<td><select class="type">
          ${TYPE_OPTIONS.map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
        </select></td>`;
        html += `<td><select class="validTill"><option value=""></option></select></td>`;
        html += `<td><textarea rows="1" placeholder=""></textarea></td>`;
        html += `</tr>`;
      }
      html += `</tbody><tfoot><tr><td><strong>Total Fees</strong></td><td></td><td colspan="${days.length}"></td><td id="classTotal-${classKey}">0</td><td></td><td></td><td></td></tr></tfoot></table>`;

      const container = document.getElementById(`classTableContainer-${classKey}`);
      container.innerHTML = html;

      // Attach behaviors
      container.querySelectorAll('input.phone').forEach(inp=> attachPhoneValidation(inp));
      container.querySelectorAll('textarea').forEach(ta=> autoResizeTA(ta));
      container.querySelectorAll('input[type="text"], textarea, select').forEach(elm => {
        elm.addEventListener('change', ()=> { updateClassTotals(classKey); saveCurrentClassState(classKey); });
        elm.addEventListener('input',  ()=> { updateClassTotals(classKey); saveCurrentClassState(classKey); });
      });

      // Populate Valid Till selects based on current month selection
      refreshValidTillOptionsFor(classKey, monthIndex, year);

      // Restore data (if any) then compute totals
      restoreClassTable(classKey);
      updateClassTotals(classKey);
    }

    function refreshValidTillOptionsFor(classKey, monthIndex, year){
      const table = document.getElementById(`classTable-${classKey}`);
      if(!table) return;
      const options = validTillLabelSeq(monthIndex, year); // 12 from selected
      const selects = table.querySelectorAll('select.validTill');
      selects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = `<option value=""></option>` + options.map(o=>`<option value="${o.value}">${o.label}</option>`).join('');
        if(current) {
          const opt = sel.querySelector(`option[value="${current}"]`);
          if(opt) sel.value = current; else sel.value = '';
        }
      });
    }

    function updateClassTotals(classKey){
      const table = document.getElementById(`classTable-${classKey}`);
      if(!table) return;
      const month = document.getElementById(`monthSelect-${classKey}`).value;
      const mId = idSafe(month);

      let present = 0, absent = 0, feesTotal = 0;

      table.querySelectorAll('tbody tr').forEach(row => {
        const feeRaw = row.querySelector('input.fee')?.value || '';
        const feeVal = sanitizeNumber(feeRaw);
        feesTotal += feeVal;

        row.querySelectorAll('select:not(.type):not(.validTill)').forEach(sel => {
          const v = sel.value;
          if(v === 'Present' || v === 'Drop-in'){
            present++;
          } else if(v === 'Absent') {
            absent++;
          }
        });
      });

      // Update class tab total
      const classTotalCell = document.getElementById(`classTotal-${classKey}`);
      if(classTotalCell) classTotalCell.textContent = feesTotal;

      // Push into Overview for this month
      const pCell = document.getElementById(`present-${classKey}-${mId}`);
      const aCell = document.getElementById(`absent-${classKey}-${mId}`);
      const fCell = document.getElementById(`fees-${classKey}-${mId}`);
      if(pCell) pCell.textContent = present;
      if(aCell) aCell.textContent = absent;
      if(fCell) fCell.textContent = feesTotal;

      updateOverviewTotalsForMonth(month);
    }

    // Build everything once
    buildOverviewTables();
    ["JazzTraining","JazzFunk","BollywoodWeekends","BalletTraining"].forEach(buildClassPanel);

    // Persist: Export / Import
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(STORE, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `imap-attendance-${Date.now()}.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    });
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      const fr = new FileReader();
      fr.onload = () => {
        try {
          const obj = JSON.parse(fr.result);
          if(!obj || typeof obj !== 'object') throw new Error('Invalid file');
          STORE = obj; persist();
          // Rebuild overview and class panels using selected months
          buildOverviewTables();
          ["JazzTraining","JazzFunk","BollywoodWeekends","BalletTraining"].forEach(classKey=>{
            const sel = document.getElementById(`monthSelect-${classKey}`);
            if(sel && STORE?.selectedMonths?.[classKey]){
              const saved = STORE.selectedMonths[classKey];
              if([...sel.options].some(o=>o.value===saved)) sel.value = saved;
            }
            generateClassTable(classKey);
          });
          recomputeOverviewFromStore();
        } catch(err){
          alert('Import failed: ' + err.message);
        }
        e.target.value = '';
      };
      fr.readAsText(file);
    });

    // Bind sync UI & possibly start auto sync
    bindSyncUI();
    setupAutoSync();
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) smartSync(); });

    // ---------------- Lightweight Test Cases ----------------
    (function runTests(){
      try {
        console.assert(typeof classLabels === 'object', 'classLabels should be an object');
        console.assert(['JazzTraining','JazzFunk','BollywoodWeekends','BalletTraining'].every(k=>k in classLabels), 'classLabels missing keys');
        console.assert(Array.isArray(months) && months.length >= 1, 'months should be a non-empty array');

        // Overview cells exist for first month
        const m0 = idSafe(months[0]);
        console.assert(document.getElementById(`present-JazzTraining-${m0}`), 'Overview present cell missing');

        // Class totals cells present
        ['JazzTraining','JazzFunk','BollywoodWeekends','BalletTraining'].forEach(key => {
          const totalCell = document.getElementById(`classTotal-${key}`);
          console.assert(totalCell, `classTotal cell missing for ${key}`);
        });

        console.log('%ciMAP sheet: basic tests passed', 'color:#0bf');
      } catch (e) {
        console.error('Test failure:', e);
      }
    })();
  </script>
</body>
</html>
